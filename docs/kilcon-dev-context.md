KilCon Development Context

This document defines how the kilConstruction system works.
It exists to prevent architectural drift and wasted rewrites.

1. Overview

The KilCon website is a static Astro site deployed on Cloudflare Pages with dynamic features powered by Pages Functions and image storage in Cloudflare R2.

Primary stack:

Astro (frontend)

Cloudflare Pages (hosting)

Pages Functions (backend API)

Cloudflare R2 (image storage)

Turnstile (spam protection)

Optional Workers (legacy, being phased out)

2. High-Level Architecture
   Browser
   ↓
   kilcon.work (Cloudflare Pages)
   ↓ (API requests)
   Pages Functions (/src/pages/api/*)
   ↓
   R2 Bucket: kilcon-gallery


Admin pages communicate directly with the Pages Functions, not with standalone Workers.

3. Repository Structure (Summarized)
   root/
   ├─ public/                 # static assets
   ├─ src/
   │   ├─ components/         # UI elements
   │   ├─ layout/             # page layouts
   │   ├─ pages/              # Astro pages + API routes
   │   │   ├─ admin/          # admin dashboard + file manager
   │   │   ├─ api/            # Pages Functions (gallery CRUD)
   │   │   └─ projects/       # project pages
   │   ├─ assets/             # images/static files
   │   ├─ styles/             # CSS
   │   └─ utils/              # helper utilities
   ├─ dist/                   # build output
   ├─ wrangler.toml           # Cloudflare config
   └─ package.json

4. API Endpoints (Pages Functions)

All new backend work must go under src/pages/api/*.

Endpoint	Method	Purpose
/api/gallery/list-images	GET	Lists folders/files from R2
/api/gallery/upload	POST	Uploads images to R2
/api/gallery/delete	POST	Deletes selected items
/api/gallery/delete-project	POST	Removes an entire folder

Each endpoint must be maintained as a stable API contract.

5. Image Storage Rules (R2)

Bucket: kilcon-gallery

Structure:

project-name/
image1.jpg
image2.webp


Every image must have a project-level folder

No trailing slashes, no mixed casing, no spaces

6. Admin Panel Requirements

The Admin UI at /admin/manage must follow these rules:

Folders show one label only

Checkboxes sit on the left of the label

Dropdown carrot sits on the folder label line

No bullet points anywhere

Nested folders indent consistently

Admin footer pinned to bottom

Must render correctly on small screens (<375px)

The Admin UI consumes only the Pages Functions API.

7. Deployment Rules

GitHub main → Cloudflare Pages → automatic deploy

dist/ is autogenerated; never commit manual changes

All env variables live in Cloudflare Pages Settings → Variables

All R2 bindings live in Cloudflare Pages Settings → Bindings

Only Pages Functions should handle gallery logic, not standalone Workers

8. Invariants (Do Not Change Without Discussion)

R2 is the single source of truth for photos

Pages Functions are the backend

API responses must not change shape silently

No unplanned migration to different storage (e.g., Drive)

All new endpoints must:

be documented here

be added to the To-Do list

include verification steps

9. Debugging Workflow

Every issue is resolved using this fixed loop:

Step 1 — Reproduce

Document expected vs actual behavior.

Step 2 — Locate Files

Identify only the files involved.

Step 3 — Apply Minimal Fix

One change, one file, one purpose.

Step 4 — Verify

Dev server (if relevant)

Cloudflare Pages build

Live site test

Real mobile device (for UI)

Cloudflare logs

R2 bucket changes

Step 5 — Update Documentation

Update this Context doc and the Master To-Do list as needed.

10. Adding New Features

Before implementing anything new:

Always consider 3 options:

Option A

Option B

Option C

With pros, cons, and a recommendation.

No new feature or architecture change should proceed until these are reviewed.

11. Glossary

Pages Functions: Cloudflare’s serverless backend inside Pages.

Worker: Standalone Cloudflare function (legacy for this project).

R2: Object storage used for images.

Turnstile: Captcha alternative for spam preven