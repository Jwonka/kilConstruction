---
import AdminLayout from "../../../layout/AdminLayout.astro";
import "../../../styles/global.css";
import "../../../styles/admin.css";
import { verifyAdminToken } from "../../../utils/adminToken";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Cloudflare runtime env
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;
const SESSION_VERSION = env.SESSION_VERSION ?? "1";

if (!ADMIN_SECRET || !SESSION_VERSION) {
    console.error("[admin] Missing ADMIN_SECRET or SESSION_VERSION in runtime env");
    return new Response("Something went wrong. Please try again later.", { status: 500 });
}

const isAdmin =
    auth && ADMIN_SECRET && SESSION_VERSION
        ? await verifyAdminToken(auth, ADMIN_SECRET, SESSION_VERSION)
        : false;

if (!isAdmin) {
    return new Response(null, { status: 302, headers: { Location: "/admin" } });
}

const db = (Astro.locals as any).runtime?.env?.DB;
if (!db) return new Response("Missing DB binding", { status: 500 });

const slug = String(Astro.params.slug || "").trim();

const item = await db
    .prepare(`SELECT id, slug, title, active FROM apparel_items WHERE slug = ?`)
    .bind(slug)
    .first();

if (!item) return new Response("Not found", { status: 404 });

const { results: variants } = await db
    .prepare(
        `SELECT size, active, price_cents as priceCents, stock, stripe_price_id as stripePriceId
     FROM apparel_variants
     WHERE item_id = ?
     ORDER BY CASE size
       WHEN 'S' THEN 1 WHEN 'M' THEN 2 WHEN 'L' THEN 3 WHEN 'XL' THEN 4
       WHEN 'XXL' THEN 5 WHEN 'XXXL' THEN 6 WHEN 'XXXXL' THEN 7
       ELSE 99 END`
    )
    .bind(item.id)
    .all();

const centsToDollars = (c: number) => (Number(c || 0) / 100).toFixed(2);
---

<AdminLayout
        title={`Edit Apparel â€” ${item.title}`}
        description={`Admin editor for apparel sizes, pricing, stock, and Stripe Price IDs for ${item.title}.`}
>
    <h1 class="admin-title">{item.title}</h1>

    <section class="panel">
        <p class="hint" style="margin-top:0;">
            Rule: If a size is enabled, it must have Price &gt; $0 and a Stripe Price ID or Save will fail.
        </p>

        <form id="variantForm" class="admin-form-flex">
            <input type="hidden" name="slug" value={item.slug} />

            <div class="apparel-admin table-wrap">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>Size</th>
                        <th>Enabled</th>
                        <th>Price ($)</th>
                        <th>Stock</th>
                        <th>Stripe Price ID</th>
                    </tr>
                    </thead>
                    <tbody>
                    {variants?.map((v: any) => (
                            <tr data-size={v.size}>
                                <td style="font-weight:700;">{v.size}</td>
                                <td data-label="Enabled">
                                    <input type="checkbox" class="active" checked={v.active === 1} />
                                </td>
                                <td data-label="Price ($)">
                                    <input
                                        type="text"
                                        inputmode="decimal"
                                        class="price admin-input"
                                        value={centsToDollars(v.priceCents)}
                                        placeholder="0.00"
                                        autocomplete="off"
                                    />
                                </td>
                                <td data-label="Stock">
                                    <input
                                        type="number"
                                        class="stock admin-input"
                                        step="1"
                                        min="0"
                                        value={String(v.stock ?? 0)}
                                    />
                                </td>
                                <td data-label="Stripe Price ID">
                                    <input
                                        type="text"
                                        class="stripe admin-input"
                                        value={v.stripePriceId ?? ""}
                                        placeholder="price_..."
                                    />
                                </td>
                            </tr>
                    ))}
                    </tbody>
                </table>
            </div>

            <div class="actions-row">
                <button type="submit" class="btn-small" id="saveBtn">Save</button>
                <span id="status" class="status-text"></span>
            </div>
        </form>
    </section>

    <script type="module">
        const form = document.getElementById("variantForm");
        const statusEl = document.getElementById("status");
        const saveBtn = document.getElementById("saveBtn");

        const dollarsToCents = (v) => {
            const s = String(v ?? "").trim().replace(/,/g, "");
            // allow: 0, 10, 10.5, 10.50
            if (!/^\d+(\.\d{0,2})?$/.test(s)) return NaN;
            const n = Number(s);
            if (!Number.isFinite(n)) return NaN;
            return Math.round(n * 100);
        };

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            statusEl.textContent = "";
            saveBtn.disabled = true;

            const slug = form.querySelector('input[name="slug"]').value;
            const rows = [...form.querySelectorAll("tbody tr")];

            const variants = rows.map((tr) => {
                const size = tr.getAttribute("data-size");
                const active = tr.querySelector(".active").checked;
                const priceCents = dollarsToCents(tr.querySelector(".price").value);
                const stock = Number(tr.querySelector(".stock").value);
                const stripePriceId = tr.querySelector(".stripe").value.trim();
                return { size, active, priceCents, stock, stripePriceId };
            });

            try {
                const r = await fetch("/api/admin/apparel/variants.save", {
                    method: "POST",
                    headers: { "content-type": "application/json" },
                    body: JSON.stringify({ slug, variants }),
                });

                const data = await r.json().catch(() => ({}));
                if (!r.ok) {
                    statusEl.textContent = `Save failed: ${data?.error || r.status}`;
                    return;
                }
                statusEl.textContent = "Saved.";
            } catch {
                statusEl.textContent = "Save failed: network error";
            } finally {
                saveBtn.disabled = false;
            }
        });
    </script>
    <style>
        .apparel-admin.table-wrap {
            overflow-x: auto;
            padding: 0 10px 10px;
            -webkit-overflow-scrolling: touch;
        }

        .apparel-admin .admin-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .apparel-admin .admin-table th,
        .apparel-admin .admin-table td {
            padding: 8px 10px;
            vertical-align: middle;
            white-space: nowrap;
            text-align: left;
        }

        .apparel-admin .admin-table th:nth-child(1),
        .apparel-admin .admin-table td:nth-child(1) { width: 64px; }   /* Size */

        .apparel-admin .admin-table th:nth-child(2),
        .apparel-admin .admin-table td:nth-child(2) { width: 86px; }   /* Enabled */

        .apparel-admin .admin-table th:nth-child(3),
        .apparel-admin .admin-table td:nth-child(3) { width: 110px; }  /* Price */

        .apparel-admin .admin-table th:nth-child(4),
        .apparel-admin .admin-table td:nth-child(4) { width: 100px; }  /* Stock */

        .apparel-admin .admin-table th:nth-child(5),
        .apparel-admin .admin-table td:nth-child(5) { width: auto; }

        .apparel-admin input.price.admin-input { width: 92px; }
        .apparel-admin input.stock.admin-input { width: 84px; }
        .apparel-admin input.stripe.admin-input { width: 100%; min-width: 200px; }

        /* This prevents the table from collapsing into stacked blocks */
        .apparel-admin .admin-table,
        .apparel-admin .admin-table thead,
        .apparel-admin .admin-table tbody,
        .apparel-admin .admin-table tr,
        .apparel-admin .admin-table th,
        .apparel-admin .admin-table td {
            display: table-row-group;
        }

        .apparel-admin .admin-table { display: table; }
        .apparel-admin .admin-table thead { display: table-header-group; }
        .apparel-admin .admin-table tbody { display: table-row-group; }
        .apparel-admin .admin-table tr { display: table-row; }
        .apparel-admin .admin-table th,
        .apparel-admin .admin-table td { display: table-cell; }

        .apparel-admin .admin-input {
            box-sizing: border-box;
        }

        .apparel-admin input[type="checkbox"].active {
            appearance: auto;
            -webkit-appearance: auto;
            width: 18px;
            height: 18px;
            margin: 0;
            vertical-align: middle;
            accent-color: #6b46c1;
        }

        /* -------- Mobile: turn each row into a compact card -------- */
        @media (max-width: 640px) {
            .apparel-admin.table-wrap {
                overflow: visible; /* avoid sideways scroll on phones */
                padding: 0 6px 10px;
            }

            .apparel-admin .admin-table {
                min-width: 720px;
                border-spacing: 0 12px;
                table-layout: auto;
            }

            .apparel-admin .admin-table thead {
                display: none; /* labels come from data-label */
            }

            .apparel-admin .admin-table,
            .apparel-admin .admin-table tbody,
            .apparel-admin .admin-table tr,
            .apparel-admin .admin-table td {
                display: block;
                width: 100%;
            }

            .apparel-admin .admin-table th,
            .apparel-admin .admin-table td {
                padding: 8px 8px;
            }

            .apparel-admin .admin-table tr {
                background: #fff;
                border-radius: 14px;
                padding: 10px 10px 12px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            }

            .apparel-admin .admin-table td {
                padding: 8px 0;
                white-space: normal;
            }

            /* Two-column grid for compact layout */
            .apparel-admin .admin-table td {
                display: grid;
                grid-template-columns: 120px 1fr;
                gap: 10px;
                align-items: center;
            }

            .apparel-admin .admin-table td::before {
                content: attr(data-label);
                font-size: 12px;
                opacity: 0.75;
            }

            /* Make "Size" feel like a header row */
            .apparel-admin .admin-table td[data-label="Size"] {
                grid-template-columns: 1fr;
                padding-top: 0;
                padding-bottom: 6px;
            }
            .apparel-admin .admin-table td[data-label="Size"]::before { display: none; }

            /* Mobile input widths */
            .apparel-admin input.price.admin-input { width: 90px; min-width: 90px; }
            .apparel-admin input.stock.admin-input { width: 70px; min-width: 70px; }
            .apparel-admin input.stripe.admin-input { min-width: 260px; }
        }
    </style>
</AdminLayout>
