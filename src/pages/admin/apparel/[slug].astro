---
import AdminLayout from "../../../layout/AdminLayout.astro";
import "../../../styles/global.css";
import "../../../styles/admin.css";
import { verifyAdminToken } from "../../../utils/adminToken";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Cloudflare runtime env
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;
const SESSION_VERSION = env.SESSION_VERSION ?? "1";

if (!ADMIN_SECRET || !SESSION_VERSION) {
    console.error("[admin] Missing ADMIN_SECRET or SESSION_VERSION in runtime env");
    return new Response("Something went wrong. Please try again later.", { status: 500 });
}

const isAdmin =
    auth && ADMIN_SECRET && SESSION_VERSION
        ? await verifyAdminToken(auth, ADMIN_SECRET, SESSION_VERSION)
        : false;

if (!isAdmin) {
    return new Response(null, { status: 302, headers: { Location: "/admin" } });
}

const db = (Astro.locals as any).runtime?.env?.DB;
if (!db) return new Response("Missing DB binding", { status: 500 });

const slug = String(Astro.params.slug || "").trim();

const item = await db
    .prepare(`SELECT id, slug, title, active FROM apparel_items WHERE slug = ?`)
    .bind(slug)
    .first();

if (!item) return new Response("Not found", { status: 404 });

const { results: variants } = await db
    .prepare(
        `SELECT size, active, price_cents as priceCents, stock, stripe_price_id as stripePriceId
     FROM apparel_variants
     WHERE item_id = ?
     ORDER BY CASE size
       WHEN 'S' THEN 1 WHEN 'M' THEN 2 WHEN 'L' THEN 3 WHEN 'XL' THEN 4
       WHEN 'XXL' THEN 5 WHEN 'XXXL' THEN 6 WHEN 'XXXXL' THEN 7
       ELSE 99 END`
    )
    .bind(item.id)
    .all();

const centsToDollars = (c: number) => (Number(c || 0) / 100).toFixed(2);
---

<AdminLayout
        title={`Edit Apparel — ${item.title}`}
        description={`Admin editor for apparel sizes, pricing, stock, and Stripe Price IDs for ${item.title}.`}
>
    <h1 class="admin-title">{item.title}</h1>

    <section class="panel">
        <p class="hint" style="margin-top:0;">
            Rule: If a size is enabled, it must have Price &gt; $0 and a Stripe Price ID or Save will fail.
        </p>

        <form id="variantForm" class="admin-form-flex">
            <input type="hidden" name="slug" value={item.slug} />

            <div class="apparel-admin table-wrap">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>Size</th>
                        <th>Enabled</th>
                        <th>Price ($)</th>
                        <th>Stock</th>
                        <th>Stripe Price ID</th>
                    </tr>
                    </thead>
                    <tbody>
                    {variants?.map((v: any) => (
                            <tr data-size={v.size}>
                                <td data-label="Size" class="size-cell" style="font-weight:700;">{v.size}</td>
                                <td data-label="Enabled">
                                    <input type="checkbox" class="active" checked={v.active === 1} />
                                </td>
                                <td data-label="Price ($)">
                                    <input
                                        type="text"
                                        inputmode="decimal"
                                        class="price admin-input"
                                        value={centsToDollars(v.priceCents)}
                                        placeholder="0.00"
                                        autocomplete="off"
                                    />
                                </td>
                                <td data-label="Stock">
                                    <input
                                        type="number"
                                        class="stock admin-input"
                                        step="1"
                                        min="0"
                                        value={String(v.stock ?? 0)}
                                    />
                                </td>
                                <td data-label="Stripe Price ID">
                                    <input
                                        type="text"
                                        class="stripe admin-input"
                                        value={v.stripePriceId ?? ""}
                                        placeholder="price_..."
                                    />
                                </td>
                            </tr>
                    ))}
                    </tbody>
                </table>
            </div>

            <div class="actions-row">
                <button type="submit" class="btn-small" id="saveBtn">Save</button>
                <span id="status" class="status-text"></span>
            </div>
        </form>
    </section>

    <script type="module">
        const form = document.getElementById("variantForm");
        const statusEl = document.getElementById("status");
        const saveBtn = document.getElementById("saveBtn");

        const dollarsToCents = (v) => {
            const s = String(v ?? "").trim().replace(/,/g, "");
            // allow: 0, 10, 10.5, 10.50
            if (!/^\d+(\.\d{0,2})?$/.test(s)) return NaN;
            const n = Number(s);
            if (!Number.isFinite(n)) return NaN;
            return Math.round(n * 100);
        };

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            statusEl.textContent = "";
            saveBtn.disabled = true;

            const slug = form.querySelector('input[name="slug"]').value;
            const rows = [...form.querySelectorAll("tbody tr")];

            const variants = rows.map((tr) => {
                const size = tr.getAttribute("data-size");
                const active = tr.querySelector(".active").checked;
                const priceCents = dollarsToCents(tr.querySelector(".price").value);
                const stock = Number(tr.querySelector(".stock").value);
                const stripePriceId = tr.querySelector(".stripe").value.trim();
                return { size, active, priceCents, stock, stripePriceId };
            });

            try {
                const r = await fetch("/api/admin/apparel/variants.save", {
                    method: "POST",
                    headers: { "content-type": "application/json" },
                    body: JSON.stringify({ slug, variants }),
                });

                const data = await r.json().catch(() => ({}));
                if (!r.ok) {
                    statusEl.textContent = `Save failed: ${data?.error || r.status}`;
                    return;
                }
                statusEl.textContent = "Saved.";
            } catch {
                statusEl.textContent = "Save failed: network error";
            } finally {
                saveBtn.disabled = false;
            }
        });
    </script>
    <style>
        /* =========================
           Desktop/tablet (>= 900): REAL TABLE
           ========================= */
        .apparel-admin.table-wrap{
            overflow: visible;
            padding: 0 10px 10px;
        }

        .apparel-admin .admin-table{
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .apparel-admin .admin-table th,
        .apparel-admin .admin-table td{
            padding: 8px 10px;
            vertical-align: middle;
            text-align: left;
            white-space: nowrap;
        }

        .apparel-admin .admin-table th:nth-child(1),
        .apparel-admin .admin-table td:nth-child(1){ width: 64px; }   /* Size */
        .apparel-admin .admin-table th:nth-child(2),
        .apparel-admin .admin-table td:nth-child(2){ width: 86px; }   /* Enabled */
        .apparel-admin .admin-table th:nth-child(3),
        .apparel-admin .admin-table td:nth-child(3){ width: 110px; }  /* Price */
        .apparel-admin .admin-table th:nth-child(4),
        .apparel-admin .admin-table td:nth-child(4){ width: 100px; }  /* Stock */
        .apparel-admin .admin-table th:nth-child(5),
        .apparel-admin .admin-table td:nth-child(5){ width: auto; }   /* Stripe */

        .apparel-admin .admin-input{
            box-sizing: border-box;
            min-width: 0;
            max-width: 100%;
        }

        .apparel-admin input.price.admin-input{ width: 92px; }
        .apparel-admin input.stock.admin-input{ width: 84px; }

        /* Key: Stripe must be allowed to shrink, no min-width */
        .apparel-admin input.stripe.admin-input{ width: 100%; min-width: 0; }

        .apparel-admin input[type="checkbox"].active{
            appearance: auto;
            -webkit-appearance: auto;
            width: 18px;
            height: 18px;
            margin: 0;
        }

        /* =========================
           Mid widths (600–899): STOP FIGHTING TABLE COLUMNS
           Turn each TR into a compact grid "row card" but keep it in the table markup.
           ========================= */
        @media (min-width: 600px) and (max-width: 899px){
            .apparel-admin .admin-table thead{ display: none; }

            .apparel-admin .admin-table,
            .apparel-admin .admin-table tbody{
                display: block;
                width: 100%;
            }

            .apparel-admin .admin-table tr{
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-areas:
                  "size enabled"
                  "price stock"
                  "stripe stripe";
                gap: 10px 12px;

                padding: 12px;
                border-radius: 14px;
                background: #fff;
                margin: 0 0 12px;

                border: 0 !important;
                box-shadow: none !important;
                background-image: none !important;
            }

            .apparel-admin .admin-table td{
                display: block;
                width: auto !important;
                padding: 0;
                white-space: normal;

                border: 0 !important;
                box-shadow: none !important;
                background: transparent !important;
            }

            .apparel-admin .admin-table td:nth-child(1){
                grid-area: size;
                font-weight: 800;
                font-size: 16px;
            }
            .apparel-admin .admin-table td:nth-child(2){
                grid-area: enabled;
                justify-self: end;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .apparel-admin .admin-table td:nth-child(3){ grid-area: price; }
            .apparel-admin .admin-table td:nth-child(4){ grid-area: stock; }
            .apparel-admin .admin-table td:nth-child(5){
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }

            .apparel-admin .admin-table td:nth-child(5)::before{
                grid-column: 1 / -1;
            }

            .apparel-admin .admin-table td:nth-child(5) input.stripe.admin-input{
                grid-column: 1 / 2;
                width: 100% !important;
                max-width: none !important;
                min-width: 0 !important;
                justify-self: stretch;
            }

            /* labels */
            .apparel-admin .admin-table td:nth-child(2)::before{
                content: "Enabled";
                font-size: 12px;
                opacity: .75;
                text-transform: uppercase;
                letter-spacing: .02em;
            }

            .apparel-admin .admin-table td:nth-child(3),
            .apparel-admin .admin-table td:nth-child(4),
            .apparel-admin .admin-table td:nth-child(5){
                display: grid;
                gap: 6px;
            }

            .apparel-admin .admin-table td:nth-child(3)::before{ content: "Price ($)"; font-size: 12px; opacity: .75; text-transform: uppercase; letter-spacing: .02em; }
            .apparel-admin .admin-table td:nth-child(4)::before{ content: "Stock";     font-size: 12px; opacity: .75; text-transform: uppercase; letter-spacing: .02em; }
            .apparel-admin .admin-table td:nth-child(5)::before{ content: "Stripe Price ID"; font-size: 12px; opacity: .75; text-transform: uppercase; letter-spacing: .02em; }

            /* inputs fill cells */
            .apparel-admin .admin-input{ width: 100%; min-width: 0; }
            .apparel-admin input.price.admin-input{ width: 100%; }
            .apparel-admin input.stock.admin-input{ width: 100%; }
            .apparel-admin input.stripe.admin-input{ width: 100%; min-width: 0; }

            .apparel-admin .admin-table tr::before,
            .apparel-admin .admin-table tr::after{
                content: none !important;
                display: none !important;
            }
        }

        @media (max-width: 599px){
            .apparel-admin .admin-table td:nth-child(5){
                display: grid;
                grid-template-columns: 1fr;
            }

            .apparel-admin .admin-table td:nth-child(5)::before{
                grid-column: 1 / -1;
            }

            .apparel-admin .admin-table td:nth-child(5) input.stripe.admin-input{
                grid-column: 1 / -1;
                width: 100% !important;
                max-width: none !important;
            }
        }
        /* =========================
           Phone (<= 420): single column stack
           ========================= */
        @media (max-width: 420px){
            .apparel-admin .admin-table tr{
                grid-template-columns: 1fr;
                grid-template-areas:
                  "size"
                  "enabled"
                  "price"
                  "stock"
                  "stripe";
            }

            .apparel-admin .admin-table td:nth-child(2){
                justify-self: start;
            }
            .apparel-admin .admin-table td:nth-child(5) input.stripe.admin-input{
                max-width: none;
                width: 100%;
            }
        }
    </style>
</AdminLayout>
