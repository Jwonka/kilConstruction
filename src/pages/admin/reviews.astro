---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Same pattern as other admin pages
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET as string | undefined;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Moderate Reviews">
    <h1 class="admin-title">Client Reviews</h1>
    <p class="admin-subtitle">
        Approve new reviews, feature them on the homepage, reply to clients, or remove spam.
    </p>

    <section class="panel">
        <div class="admin-controls-row">
            <label>
                Status
                <select id="filter-status" class="admin-input">
                    <option value="">All</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="hidden">Hidden</option>
                </select>
            </label>

            <label>
                Project type
                <select id="filter-type" class="admin-input">
                    <option value="">All</option>
                    <option value="new-construction">New construction</option>
                    <option value="remodel">Remodel</option>
                    <option value="furniture">Furniture</option>
                    <option value="other">Other</option>
                </select>
            </label>

            <button id="refresh-reviews" class="admin-button">
                Refresh
            </button>
        </div>

        <div id="reviews-status" class="admin-status"></div>

        <div class="table-wrap">
            <table class="admin-table" id="reviews-table">
                <thead>
                <tr>
                    <th>Client</th>
                    <th>Project</th>
                    <th>Rating</th>
                    <th>Status</th>
                    <th>Featured</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="reviews-tbody">
                <!-- filled by JS -->
                </tbody>
            </table>
        </div>
    </section>

    <script type="module">
        const API_BASE = "/api/reviews/admin";

        const tbody = document.getElementById("reviews-tbody");
        const statusEl = document.getElementById("reviews-status");
        const filterStatus = document.getElementById("filter-status");
        const filterType = document.getElementById("filter-type");
        const refreshBtn = document.getElementById("refresh-reviews");

        function setStatus(msg, isError = false) {
            if (!statusEl) return;
            statusEl.textContent = msg || "";
            statusEl.classList.toggle("status--error", !!isError);
        }

        function projectTypeLabel(type) {
            switch (type) {
                case "new-construction": return "New construction";
                case "remodel": return "Remodel";
                case "furniture": return "Furniture";
                default: return "Other";
            }
        }

        function formatDate(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            if (isNaN(d.getTime())) return "";
            return d.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        async function fetchReviews() {
            try {
                setStatus("Loading…");
                const params = new URLSearchParams();
                if (filterStatus.value) params.set("status", filterStatus.value);
                if (filterType.value) params.set("projectType", filterType.value);

                const res = await fetch(`/api/reviews/admin/list?${params.toString()}`, {
                    credentials: "include",
                });
                if (!res.ok) {
                    setStatus("Failed to load reviews.", true);
                    return;
                }

                const data = await res.json();
                const reviews = Array.isArray(data.reviews) ? data.reviews : [];
                renderReviews(reviews);
                setStatus(reviews.length ? `Loaded ${reviews.length} review(s).` : "No reviews found.");
            } catch (e) {
                console.error("admin reviews load error", e);
                setStatus("Error loading reviews.", true);
            }
        }

        function renderReviews(reviews) {
            if (!tbody) return;
            tbody.innerHTML = "";

            for (const r of reviews) {
                const tr = document.createElement("tr");
                tr.dataset.id = r.id;
                tr.dataset.reply = r.adminReply || "";

                const clientCell = document.createElement("td");
                clientCell.innerHTML = `
                  <strong>${escapeHtml(r.clientNamePublic || "Client")}</strong>
                  ${r.location ? `<br><small>${escapeHtml(r.location)}</small>` : ""}
                `;

                if (r.clientEmail) {
                    clientCell.title = r.clientEmail; // still accessible on hover
                }

                const fullText = r.text || "";

                const projectCell = document.createElement("td");
                projectCell.innerHTML = `
                  ${escapeHtml(projectTypeLabel(r.projectType))}<br>
                  <small class="admin-review-body">${escapeHtml(fullText)}</small>
                  ${r.createdAt ? `<br><small class="admin-date">${escapeHtml(formatDate(r.createdAt))}</small>` : ""}
                `;

                const ratingCell = document.createElement("td");
                ratingCell.textContent = `${r.rating} ★`;

                const statusCell = document.createElement("td");
                statusCell.textContent = r.status;

                const featuredCell = document.createElement("td");
                featuredCell.textContent = r.featured ? "Yes" : "No";

                const actionsCell = document.createElement("td");
                actionsCell.innerHTML = `
          <button class="admin-button-sm js-approve">Approve</button>
          <button class="admin-button-sm js-hide">Hide</button>
          <button class="admin-button-sm js-toggle-feature">${r.featured ? "Unfeature" : "Feature"}</button>
          <button class="admin-button-sm js-reply">Reply</button>
          <button class="admin-button-sm admin-button-danger js-delete">Delete</button>
        `;

                tr.appendChild(clientCell);
                tr.appendChild(projectCell);
                tr.appendChild(ratingCell);
                tr.appendChild(statusCell);
                tr.appendChild(featuredCell);
                tr.appendChild(actionsCell);

                tbody.appendChild(tr);
            }
        }

        async function updateStatus(id, status, featured) {
            try {
                const res = await fetch("/api/reviews/admin/status", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id, status, featured }),
                });
                if (!res.ok) throw new Error("status update failed");
                await fetchReviews();
            } catch (e) {
                console.error(e);
                setStatus("Failed to update status.", true);
            }
        }

        async function sendReply(id, replyText) {
            try {
                const res = await fetch("/api/reviews/admin/reply", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id, replyText }),
                });
                if (!res.ok) throw new Error("reply failed");
                await fetchReviews();
            } catch (e) {
                console.error(e);
                setStatus("Failed to save reply.", true);
            }
        }

        async function deleteReview(id) {
            if (!confirm("Delete this review permanently?")) return;
            try {
                const res = await fetch("/api/reviews/admin/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id }),
                });
                if (!res.ok) throw new Error("delete failed");
                await fetchReviews();
            } catch (e) {
                console.error(e);
                setStatus("Failed to delete review.", true);
            }
        }

        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        if (tbody) {
            tbody.addEventListener("click", (ev) => {
                const target = ev.target;
                if (!(target instanceof HTMLElement)) return;
                const tr = target.closest("tr");
                if (!tr || !tr.dataset.id) return;
                const id = tr.dataset.id;

                if (target.classList.contains("js-approve")) {
                    updateStatus(id, "approved", tr.querySelector(".js-toggle-feature")?.textContent === "Unfeature");
                } else if (target.classList.contains("js-hide")) {
                    updateStatus(id, "hidden", false);
                } else if (target.classList.contains("js-toggle-feature")) {
                    const currentlyFeatured = target.textContent === "Unfeature";
                    updateStatus(id, tr.querySelector("td:nth-child(4)")?.textContent || "approved", !currentlyFeatured);
                } else if (target.classList.contains("js-reply")) {
                    // Toggle inline reply editor
                    const actionsCell = tr.querySelector("td:last-child");
                    if (!actionsCell) return;

                    let editor = actionsCell.querySelector(".reply-editor");
                    if (editor) {
                        // if already open, close it
                        editor.remove();
                        return;
                    }

                    editor = document.createElement("div");
                    editor.className = "reply-editor";

                    const existingText = tr.dataset.reply || "";

                    editor.innerHTML = `
                        <textarea class="reply-input" rows="3" placeholder="Type your reply to the client...">${escapeHtml(existingText)}</textarea>
                        <div class="reply-editor-actions">
                          <button type="button" class="admin-button-sm js-save-reply">Save</button>
                          <button type="button" class="admin-button-sm js-cancel-reply">Cancel</button>
                        </div>
                      `;

                    actionsCell.appendChild(editor);

                } else if (target.classList.contains("js-save-reply")) {
                    const editor = target.closest(".reply-editor");
                    if (!editor) return;
                    const textarea = editor.querySelector(".reply-input");
                    const text = textarea ? textarea.value.trim() : "";
                    sendReply(id, text);

                } else if (target.classList.contains("js-cancel-reply")) {
                    const editor = target.closest(".reply-editor");
                    if (editor) editor.remove();
                } else if (target.classList.contains("js-delete")) {
                        deleteReview(id);
                }
            });
        }

        if (refreshBtn) {
            refreshBtn.addEventListener("click", () => {
                fetchReviews();
            });
        }
        if (filterStatus) {
            filterStatus.addEventListener("change", () => fetchReviews());
        }
        if (filterType) {
            filterType.addEventListener("change", () => fetchReviews());
        }

        // initial load
        fetchReviews();
    </script>
</AdminLayout>
