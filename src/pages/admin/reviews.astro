---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}

// TODO: replace this with real data (KV / DB / API)
const reviews = [
    {
        id: "r1",
        client: "Jane Doe",
        subject: "Deck rebuild",
        rating: 5,
        createdAt: "2024-10-01",
        text: "KIL Construction did an awesome job on our deck.",
    },
    {
        id: "r2",
        client: "John Smith",
        subject: "Kitchen remodel",
        rating: 4,
        createdAt: "2024-09-15",
        text: "Very happy with the work and communication.",
    },
];
---

<AdminLayout title="Moderate Reviews">
    <h1 class="admin-title">Moderate Reviews</h1>
    <p class="admin-subtitle">
        View reviews currently shown on the public site. In a later step we’ll hook
        these actions up to a real backend for delete / moderation.
    </p>

    <section class="panel">
        <div class="toolbar">
            <label for="reviewSearch"></label><input
                    id="reviewSearch"
                    type="search"
                    placeholder="Search by client name or subject…"
                    class="search-input"
            />
        </div>

        <ul id="reviewList" class="review-list" data-json={JSON.stringify(reviews)}></ul>
    </section>

    <script>
        // @ts-nocheck
        document.addEventListener("DOMContentLoaded", () => {
            const listEl = document.getElementById("reviewList") as HTMLUListElement | null;
            const searchEl = document.getElementById("reviewSearch") as HTMLInputElement | null;

            if (!listEl || !searchEl) {
                console.error("[admin/reviews] Missing reviewList or reviewSearch element");
                return;
            }

            const raw = listEl.dataset.json ?? "[]";

            let items = JSON.parse(raw);

            function render() {
                const q = searchEl.value.trim().toLowerCase();
                listEl.innerHTML = "";

                const filtered = items.filter((r) => {
                    if (!q) return true;
                    return (
                        r.client.toLowerCase().includes(q) ||
                        r.subject.toLowerCase().includes(q)
                    );
                });

                if (!filtered.length) {
                    listEl.innerHTML =
                        '<li class="empty">No reviews match that search.</li>';
                    return;
                }

                for (const r of filtered) {
                    const li = document.createElement("li");
                    li.className = "review-item";

                    li.innerHTML = `
          <div class="review-main">
            <div class="review-header">
              <span class="review-client">${r.client}</span>
              <span class="review-rating">★ ${r.rating}</span>
            </div>
            <div class="review-subject">${r.subject}</div>
            <div class="review-meta">${r.createdAt}</div>
            <p class="review-text">${r.text}</p>
          </div>
          <div class="review-actions">
            <button class="btn-pill btn-danger" data-id="${r.id}" data-action="delete">
              Delete
            </button>
            <button class="btn-pill btn-primary" data-id="${r.id}" data-action="reply">
              Reply
            </button>
          </div>
        `;

                    listEl.appendChild(li);
                }
            }

            listEl.addEventListener("click", (ev) => {
                const target = ev.target as HTMLElement | null;
                if (!target) return;

                const action = target.dataset.action;
                const id = target.dataset.id;
                if (!action || !id) return;

                const review = items.find((r) => r.id === id);
                if (!review) return;

                if (action === "delete") {
                    const ok = confirm(
                        `Delete review from "${review.client}" about "${review.subject}"?`
                    );
                    if (!ok) return;
                    console.log("[admin] Would delete review:", review);
                    alert("Delete is not wired to the backend yet; this is just a preview.");
                }

                if (action === "reply") {
                    const subject = encodeURIComponent(
                        `Reply to your review: ${review.subject}`
                    );
                    const body = encodeURIComponent(
                        `Hi ${review.client},\n\nThanks for your review about "${review.subject}".\n\n(Write your reply here.)\n\n— KIL Construction`
                    );
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                }
            });

            searchEl.addEventListener("input", render);
            render();
        });
    </script>
</AdminLayout>
