---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";
import { verifyAdminToken } from "../../utils/adminToken";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;
const SESSION_VERSION  = env.SESSION_VERSION ?? "1";

if (!ADMIN_SECRET || !SESSION_VERSION) {
    console.error("[admin] Missing ADMIN_SECRET or SESSION_VERSION in runtime env");
    return new Response("Something went wrong. Please try again later.", { status: 500 });
}

const isAdmin = auth && ADMIN_SECRET && SESSION_VERSION
    ? await verifyAdminToken(auth, ADMIN_SECRET, SESSION_VERSION)
    : false;

if (!isAdmin) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Moderate Reviews" description="Admin review management.">
    <h1 class="admin-title">Client Reviews</h1>
    <p class="admin-subtitle">
        Approve new reviews, feature them on the homepage, reply to clients, or remove spam.
    </p>

    <section class="panel">
        <div class="admin-controls-row">
            <label>
                Status
                <select id="filter-status" class="admin-input">
                    <option value="">All</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="hidden">Hidden</option>
                </select>
            </label>

            <label>
                Project type
                <select id="filter-type" class="admin-input">
                    <option value="">All</option>
                    <option value="new-construction">New construction</option>
                    <option value="remodel">Remodel</option>
                    <option value="furniture">Furniture</option>
                    <option value="other">Other</option>
                </select>
            </label>

            <button id="refresh-reviews" class="admin-button">
                Refresh
            </button>
        </div>

        <div id="reviews-status" class="admin-status"></div>

        <div class="table-wrap">
            <table class="admin-table" id="reviews-table">
                <thead>
                <tr>
                    <th>Client</th>
                    <th>Project</th>
                    <th>Rating</th>
                    <th>Status</th>
                    <th>Featured</th>
                    <th>Photo</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="reviews-tbody">
                <!-- filled by JS -->
                </tbody>
            </table>
        </div>
    </section>
    <script>
        import initAdminReviewsPage from "./reviews-script";
        initAdminReviewsPage();
    </script>
</AdminLayout>
