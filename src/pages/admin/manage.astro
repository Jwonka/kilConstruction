---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Cloudflare runtime env
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;

// build-time public API URL for the worker
const PUBLIC_GALLERY_API = import.meta.env.PUBLIC_GALLERY_API || "https://kilcon.work/api/gallery-api";

const ADMIN_API_BASE = import.meta.env.DEV
    ? PUBLIC_GALLERY_API          // dev → hit remote worker
    : "/api/gallery-api";

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---
<AdminLayout title="Manage Images" description="Admin image management.">
    <h1 class="admin-title">Manage Images</h1>
    <p class="admin-subtitle">
        Browse and search existing folders from the R2 gallery bucket.
        Expand a folder to see its files and select items to delete.
    </p>

    <section class="panel">
        <div class="toolbar">
            <label for="search"></label><input
                    id="search"
                    type="search"
                    placeholder="Search by folder or file name…"
                    class="search-input"
            />
            <div class="toolbar-actions">
                <button id="refresh" type="button" class="btn-small">
                    Refresh
                </button>
                <button id="bulk-delete" type="button" class="btn-small btn-danger">
                    Delete selected
                </button>
            </div>
        </div>

        <div id="status" class="status-row">Loading projects…</div>

        <ul id="results" class="results-list" data-public-api={PUBLIC_GALLERY_API} data-admin-api={ADMIN_API_BASE}></ul>
    </section>
    <script>
        import initManagePage from "./manage-script";
        initManagePage();
    </script>
</AdminLayout>
