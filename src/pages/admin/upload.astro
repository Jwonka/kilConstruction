---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Runtime env from Cloudflare Pages
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET as string | undefined;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Upload Images">
    <h1 class="admin-title">Upload Images</h1>
    <p class="admin-subtitle">
        Upload new images to the R2 gallery bucket. You can upload a whole folder
        or individual files.
    </p>

    <section class="panel">
        <form id="admin-upload-form" class="admin-form-flex">
            <div class="admin-form-grid">

                <label class="admin-field-label">
                    <span>Category</span>
                    <select id="category" name="category" class="admin-input" required>
                        <option value="uploads">Uploads</option>
                        <option value="Projects">Projects</option>
                        <option value="Highlights">Highlights</option>
                        <option value="New Construction">New Construction</option>
                        <option value="Remodels">Remodels</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Apparel">Apparel</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Images</span>
                    <input
                            id="fileInput"
                            type="file"
                            name="files"
                            multiple
                            accept="image/*"
                            capture="environment"
                            class="admin-input"
                    />
                    <small class="hint">
                        Choose one or more images from your gallery, or use the camera on
                        mobile. Files are stored under the selected category and subfolder.
                    </small>
                </label>
            </div>

            <label class="admin-field-label">
                <span>Subfolder (project / album name)</span>

                <div class="subfolder-row">
                    <select id="subfolder-select" class="admin-input">
                        <option value="">â€” Select folder â€”</option>
                        <option value="__NEW__">âž• Create new folderâ€¦</option>
                    </select>
                </div>

                <input
                        id="subfolder-custom"
                        type="text"
                        class="admin-input"
                        placeholder="Enter new folder nameâ€¦"
                        style="display:none;margin-top:8px;"
                />
                <small class="hint">
                    Leave subfolder blank to infer a name from the first file.
                    For Projects, this becomes the project folder and slug (Pfaffe House â†’ /projects/pfaffe-house/).
                    For all other categories, files go into a <code>misc</code> folder inside that category.
                </small>
            </label>

            <div class="actions-row">
                <button type="submit" class="btn admin-btn" id="submitBtn">
                    ðŸ“¤ Upload
                </button>
                <span id="status" class="status-text"></span>
            </div>

            <div id="result" class="upload-result"></div>
        </form>
    </section>

    <script>
        // @ts-nocheck
        const formEl = document.getElementById("admin-upload-form");
        const categoryEl = document.getElementById("category");
        const subfolderEl = document.getElementById("subfolder");
        const fileInput = document.getElementById("fileInput");
        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");
        const submitBtn = document.getElementById("submitBtn");
        const subfolderSelectEl = document.getElementById("subfolder-select");
        const subfolderCustomEl = document.getElementById("subfolder-custom");
        const subfoldersByCategory = new Map();

        // cache of all prefixes from the API
        let allPrefixes = [];

        // same base we use for uploads
        const API_BASE = import.meta.env.DEV
            ? (import.meta.env.PUBLIC_GALLERY_API || "https://kilcon.work/api/gallery-api")
            : "/api/gallery-api";

        async function loadAllFolders() {
            try {
                const res = await fetch(`${API_BASE}?all=1`, { credentials: "include" });
                const data = await res.json().catch(() => ({}));

                const projects = Array.isArray(data.projects) ? data.projects : [];
                subfoldersByCategory.clear();

                for (const p of projects) {
                    const rawPrefix = p.prefix || decodeURIComponent(p.slug || "");
                    if (!rawPrefix) continue;

                    const noSlash = rawPrefix.replace(/\/$/, ""); // "Projects/Pfaffe House"
                    const [top, ...rest] = noSlash.split("/");    // ["Projects", "Pfaffe House"]
                    if (!top || !rest.length) continue;

                    const folderName = rest.join("/");           // "Pfaffe House" or "Fox_Hollow_Retriever"
                    if (!folderName) continue;

                    if (!subfoldersByCategory.has(top)) {
                        subfoldersByCategory.set(top, new Set());
                    }
                    subfoldersByCategory.get(top).add(folderName);
                }

                rebuildSubfolderSelect();
            } catch (e) {
                console.error("[upload] failed to load folders", e);
            }
        }

        function rebuildSubfolderSelect() {
            if (!subfolderSelectEl) return;

            const category = (categoryEl.value || "").trim();
            subfolderSelectEl.innerHTML = "";

            // always have base options
            subfolderSelectEl.appendChild(new Option("â€” Select folder â€”", ""));
            const set =
                subfoldersByCategory.get(category) ||
                subfoldersByCategory.get(category.toLowerCase()) ||
                new Set();

            // sort for cleaner UX
            const sorted = Array.from(set).sort((a, b) =>
                a.localeCompare(b, undefined, { sensitivity: "base", numeric: true })
            );

            for (const name of sorted) {
                const label = name.replace(/_/g, " ");
                subfolderSelectEl.appendChild(new Option(label, name));
            }

            subfolderSelectEl.appendChild(new Option("âž• Create new folderâ€¦", "__NEW__"));
            subfolderSelectEl.value = "";
            subfolderCustomEl.style.display = "none";
            subfolderCustomEl.value = "";
        }
        // reload list when category changes
        categoryEl.addEventListener("change", rebuildSubfolderSelect);

        subfolderSelectEl.addEventListener("change", () => {
            if (subfolderSelectEl.value === "__NEW__") {
                subfolderCustomEl.style.display = "block";
                subfolderCustomEl.focus();
            } else {
                subfolderCustomEl.style.display = "none";
                subfolderCustomEl.value = "";
            }
        });

        // initial load
        loadAllFolders();

        function slugifyName(name) {
            return (name || "")
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/gi, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "") || "project";
        }

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            if (!files || !files.length) {
                alert("Please choose at least one image.");
                return;
            }

            const category = categoryEl.value.trim();
            if (!category) {
                alert("Please choose a category.");
                return;
            }

            let subfolder = "";

            // 1) existing folder from dropdown
            if (subfolderSelectEl.value && subfolderSelectEl.value !== "__NEW__") {
                subfolder = subfolderSelectEl.value.trim();
            }

            // 2) "Create new" path â†’ use custom text
            if (!subfolder && subfolderSelectEl.value === "__NEW__") {
                subfolder = subfolderCustomEl.value.trim();
            }

            // 3) Fallbacks
            if (!subfolder) {
                if (category === "Projects") {
                    const first = files[0];
                    const base = (first.webkitRelativePath || first.name || "project")
                        .split("/")[0];
                    subfolder = base || "project";
                } else {
                    subfolder = "misc";
                }
            }
            subfolder = subfolder.replace(/\/+$/, "");

            const formData = new FormData();

            for (const file of files) {
                // just put files under category/subfolder
                const cleanedName = file.name || "image";
                const fullPath = `${category}/${subfolder}/${cleanedName}`.replace(/\/+/g, "/");
                formData.append(fullPath, file);
            }

            statusEl.textContent = "Uploadingâ€¦";
            resultEl.innerHTML = "";
            submitBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: "POST",
                    body: formData,
                    credentials: "include",
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    const list = (data.urls || [])
                        .map(
                            (u) =>
                                `<li><a href="${u}" target="_blank" rel="noreferrer">${u}</a></li>`
                        )
                        .join("");

                    resultEl.innerHTML =
                        `<p>Uploaded ${(data.uploaded ?? data.urls?.length) || 0} files:</p><ul>${list}</ul>`;
                    statusEl.textContent = "Upload complete.";
                    fileInput.value = "";
                    loadAllFolders();
                } else {
                    statusEl.textContent = "Upload failed.";
                    resultEl.textContent = data.error || "Server returned an error.";
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Upload error â€“ see console.";
                resultEl.textContent = "";
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</AdminLayout>

