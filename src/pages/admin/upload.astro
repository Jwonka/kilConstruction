---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Runtime env from Cloudflare Pages
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET as string | undefined;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Upload Images">
    <h1 class="admin-title">Upload Images</h1>
    <p class="admin-subtitle">
        Upload new images to the R2 gallery bucket. You can upload a whole folder
        or individual files.
    </p>

    <section class="panel">
        <form id="admin-upload-form" class="admin-form-flex">
            <div class="admin-form-grid">

                <label class="admin-field-label">
                    <span>Category</span>
                    <select id="category" name="category" class="admin-input" required>
                        <option value="uploads">Uploads</option>
                        <option value="Projects">Projects</option>
                        <option value="Highlights">Highlights</option>
                        <option value="New Construction">New Construction</option>
                        <option value="Remodels">Remodels</option>
                        <option value="Furniture">Furniture</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Images</span>
                    <input
                            id="fileInput"
                            type="file"
                            name="files"
                            multiple
                            accept="image/*"
                            capture="environment"
                            class="admin-input"
                    />
                    <small class="hint">
                        Choose one or more images from your gallery, or use the camera on
                        mobile. Files are stored under the selected category and subfolder.
                    </small>
                </label>
            </div>

            <label class="admin-field-label">
                <span>Subfolder (project / album name)</span>
                <input
                        id="subfolder"
                        name="subfolder"
                        type="text"
                        placeholder="e.g. Pfaffe House"
                        class="admin-input"
                />
                <small class="hint">
                    Leave subfolder blank to infer a name from the first file.
                    For Projects, this becomes the project folder and slug (Pfaffe House â†’ /projects/pfaffe-house/).
                    For all other categories, files go into a <code>misc</code> folder inside that category.
                </small>
            </label>

            <label class="admin-field-label">
                <span>Notes (optional)</span>
                <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        class="admin-input"
                        style="resize: vertical;"
                ></textarea>
            </label>

            <div class="actions-row">
                <button type="submit" class="btn admin-btn" id="submitBtn">
                    ðŸ“¤ Upload
                </button>
                <span id="status" class="status-text"></span>
            </div>

            <div id="result" class="upload-result"></div>
        </form>
    </section>

    <script>
        // @ts-nocheck
        const formEl = document.getElementById("admin-upload-form");
        const categoryEl = document.getElementById("category");
        const subfolderEl = document.getElementById("subfolder");
        const fileInput = document.getElementById("fileInput");
        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");
        const submitBtn = document.getElementById("submitBtn");

        function slugifyName(name) {
            return (name || "")
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/gi, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "") || "project";
        }

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            if (!files || !files.length) {
                alert("Please choose at least one image.");
                return;
            }

            const category = categoryEl.value.trim();
            if (!category) {
                alert("Please choose a category.");
                return;
            }

            let subfolder = subfolderEl.value.trim().replace(/\/+$/, "");

            // If no subfolder, infer from first file name for projects; otherwise "misc"
            if (!subfolder) {
                if (category === "Projects") {
                    const first = files[0];
                    const base = (first.webkitRelativePath || first.name || "project")
                        .split("/")
                        .shift();
                    subfolder = base || "project";
                } else {
                    subfolder = "misc";
                }
            }

            const formData = new FormData();

            for (const file of files) {
                // just put files under category/subfolder
                const cleanedName = file.name || "image";
                const fullPath = `${category}/${subfolder}/${cleanedName}`.replace(/\/+/g, "/");
                formData.append(fullPath, file);
            }

            const notesEl = document.getElementById("notes");
            const notes = notesEl && notesEl.value ? notesEl.value.trim() : "";
            if (notes) {
                formData.append("notes", notes);
            }

            statusEl.textContent = "Uploadingâ€¦";
            resultEl.innerHTML = "";
            submitBtn.disabled = true;

            try {
                const API_BASE ="/api/gallery";

                const res = await fetch(`${API_BASE}/upload`, {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    const list = (data.urls || [])
                        .map(
                            (u) =>
                                `<li><a href="${u}" target="_blank" rel="noreferrer">${u}</a></li>`
                        )
                        .join("");

                    resultEl.innerHTML =
                        `<p>Uploaded ${(data.uploaded ?? data.urls?.length) || 0} files:</p><ul>${list}</ul>`;
                    statusEl.textContent = "Upload complete.";
                    fileInput.value = "";
                } else {
                    statusEl.textContent = "Upload failed.";
                    resultEl.textContent = data.error || "Server returned an error.";
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Upload error â€“ see console.";
                resultEl.textContent = "";
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</AdminLayout>

