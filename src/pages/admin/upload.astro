---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Runtime env from Cloudflare Pages
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET as string | undefined;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Upload Images">
    <h1 class="admin-title">Upload Images</h1>
    <p class="admin-subtitle">
        Upload new images to the R2 gallery bucket. You can upload a whole folder
        or individual files.
    </p>

    <section class="panel">
        <form id="admin-upload-form" class="admin-form-flex">
            <div class="admin-form-grid">

                <label class="admin-field-label">
                    <span>Category</span>
                    <select id="category" name="category" class="admin-input" required>
                        <option value="uploads">Uploads</option>
                        <option value="Projects">Projects</option>
                        <option value="Highlights">Highlights</option>
                        <option value="New Construction">New Construction</option>
                        <option value="Remodels">Remodels</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Apparel">Apparel</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Images</span>
                    <input
                            id="fileInput"
                            type="file"
                            name="files"
                            multiple
                            accept="image/*"
                            capture="environment"
                            class="admin-input"
                    />
                    <small class="hint">
                        Choose one or more images from your gallery, or use the camera on
                        mobile. Files are stored under the selected category and subfolder.
                    </small>
                </label>
            </div>

            <label class="admin-field-label">
                <span>Subfolder (project / album name)</span>
                <input
                        id="subfolder"
                        name="subfolder"
                        type="text"
                        list="subfolder-list"
                        placeholder="e.g. Pfaffe House"
                        class="admin-input"
                />
                <datalist id="subfolder-list"></datalist>
                <small class="hint">
                    Leave subfolder blank to infer a name from the first file.
                    For Projects, this becomes the project folder and slug (Pfaffe House â†’ /projects/pfaffe-house/).
                    For all other categories, files go into a <code>misc</code> folder inside that category.
                </small>
            </label>

            <div class="actions-row">
                <button type="submit" class="btn admin-btn" id="submitBtn">
                    ðŸ“¤ Upload
                </button>
                <span id="status" class="status-text"></span>
            </div>

            <div id="result" class="upload-result"></div>
        </form>
    </section>

    <script>
        // @ts-nocheck
        const formEl = document.getElementById("admin-upload-form");
        const categoryEl = document.getElementById("category");
        const subfolderEl = document.getElementById("subfolder");
        const fileInput = document.getElementById("fileInput");
        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");
        const submitBtn = document.getElementById("submitBtn");
        const subfolderListEl = document.getElementById("subfolder-list");

        // cache of all prefixes from the API
        let allPrefixes = [];

        // same base we use for uploads
        const API_BASE = import.meta.env.DEV
            ? (import.meta.env.PUBLIC_GALLERY_API || "https://kilcon.work/api/gallery-api")
            : "/api/gallery-api";

        async function loadAllFolders() {
            try {
                const res = await fetch(`${API_BASE}?all=1`, { credentials: "include" });
                const data = await res.json().catch(() => ({}));
                // shape matches manage.astro: { projects: [{ prefix, slug, name, ... }, ...] }
                allPrefixes = Array.isArray(data.projects) ? data.projects : [];
                updateSubfolderOptions();
            } catch (e) {
                console.error("[upload] failed to load folders", e);
            }
        }

        function updateSubfolderOptions() {
            if (!subfolderListEl) return;
            const category = (categoryEl.value || "").trim();
            subfolderListEl.innerHTML = "";

            if (!category || !allPrefixes.length) return;

            // Filter to this category and extract the folder name segment
            const seen = new Set();

            for (const p of allPrefixes) {
                const rawPrefix = p.prefix || decodeURIComponent(p.slug || "");
                if (!rawPrefix) continue;

                const noSlash = rawPrefix.replace(/\/$/, "");      // "Projects/Pfaffe House"
                const [top, ...rest] = noSlash.split("/");         // ["Projects", "Pfaffe House"]
                if (top !== category) continue;

                const folderName = rest.join("/");                 // "Pfaffe House" (or "Fox_Hollow_Retriever")
                if (!folderName || seen.has(folderName)) continue;
                seen.add(folderName);

                const opt = document.createElement("option");
                opt.value = folderName;
                opt.label = folderName.replace(/_/g, " ");         // pretty display
                subfolderListEl.appendChild(opt);
            }
        }

        // reload list when category changes
        categoryEl.addEventListener("change", updateSubfolderOptions);

        // initial load
        loadAllFolders();

        function slugifyName(name) {
            return (name || "")
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/gi, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "") || "project";
        }

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            if (!files || !files.length) {
                alert("Please choose at least one image.");
                return;
            }

            const category = categoryEl.value.trim();
            if (!category) {
                alert("Please choose a category.");
                return;
            }

            let subfolder = subfolderEl.value.trim().replace(/\/+$/, "");

            // If no subfolder, infer from first file name for projects; otherwise "misc"
            if (!subfolder) {
                if (category === "Projects") {
                    const first = files[0];
                    const base = (first.webkitRelativePath || first.name || "project")
                        .split("/")
                        .shift();
                    subfolder = base || "project";
                } else {
                    subfolder = "misc";
                }
            }

            const formData = new FormData();

            for (const file of files) {
                // just put files under category/subfolder
                const cleanedName = file.name || "image";
                const fullPath = `${category}/${subfolder}/${cleanedName}`.replace(/\/+/g, "/");
                formData.append(fullPath, file);
            }

            statusEl.textContent = "Uploadingâ€¦";
            resultEl.innerHTML = "";
            submitBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: "POST",
                    body: formData,
                    credentials: "include",
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    const list = (data.urls || [])
                        .map(
                            (u) =>
                                `<li><a href="${u}" target="_blank" rel="noreferrer">${u}</a></li>`
                        )
                        .join("");

                    resultEl.innerHTML =
                        `<p>Uploaded ${(data.uploaded ?? data.urls?.length) || 0} files:</p><ul>${list}</ul>`;
                    statusEl.textContent = "Upload complete.";
                    fileInput.value = "";
                    loadAllFolders();
                } else {
                    statusEl.textContent = "Upload failed.";
                    resultEl.textContent = data.error || "Server returned an error.";
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Upload error â€“ see console.";
                resultEl.textContent = "";
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</AdminLayout>

