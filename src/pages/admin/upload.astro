---
import AdminLayout from "../../layout/AdminLayout.astro";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";

// Runtime env from Cloudflare Pages
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET as string | undefined;

if (!ADMIN_SECRET || auth !== ADMIN_SECRET) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Upload Images">
    <h1 class="admin-title">Upload Images</h1>
    <p class="admin-subtitle">
        Upload new images to the R2 gallery bucket. You can upload a whole folder
        or individual files.
    </p>

    <section class="panel">
        <form id="admin-upload-form" class="admin-form">
            <div class="admin-form-grid">
                <label class="admin-field-label">
                    <span>Upload mode</span>
                    <select id="mode" name="mode" class="admin-input">
                        <option value="folder">Upload a folder (recommended)</option>
                        <option value="files">Upload individual files</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Category</span>
                    <select id="category" name="category" class="admin-input" required>
                        <option value="Projects">Projects</option>
                        <option value="Highlights">Highlights</option>
                        <option value="Services">Services</option>
                        <option value="New Construction">New Construction</option>
                        <option value="Remodels">Remodels</option>
                        <option value="Furniture">Furniture</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Subfolder name</span>
                    <input
                            id="subfolder"
                            name="subfolder"
                            class="admin-input"
                            placeholder="Optional ‚Äì inferred from folder if left blank"
                    />
                </label>
            </div>

            <label class="admin-field-label">
                <span>Files / Folder</span>
                <input
                        id="fileInput"
                        type="file"
                        name="files"
                        multiple
                        class="admin-input"
                />
                <small class="hint">
                    In ‚Äúfolder‚Äù mode, pick a folder (supports nested folders). In
                    ‚Äúfiles‚Äù mode, pick one or more individual images.
                </small>
            </label>

            <label class="admin-field-label">
                <span>Notes (optional)</span>
                <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        class="admin-input"
                        style="resize: vertical;"
                ></textarea>
            </label>

            <div class="actions-row">
                <button type="submit" class="btn admin-btn" id="submitBtn">
                    üì§ Upload
                </button>
                <span id="status" class="status-text"></span>
            </div>

            <div id="result" class="upload-result"></div>
        </form>
    </section>

    <script>
        // @ts-nocheck
        const formEl = document.getElementById("admin-upload-form");
        const modeEl = document.getElementById("mode");
        const categoryEl = document.getElementById("category");
        const subfolderEl = document.getElementById("subfolder");
        const fileInput = document.getElementById("fileInput");
        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");
        const submitBtn = document.getElementById("submitBtn");

        function applyMode() {
            const mode = modeEl.value;
            if (mode === "folder") {
                fileInput.setAttribute("webkitdirectory", "");
                fileInput.setAttribute("directory", "");
            } else {
                fileInput.removeAttribute("webkitdirectory");
                fileInput.removeAttribute("directory");
            }
            fileInput.value = ""; // reset selection when mode changes
        }

        modeEl.addEventListener("change", applyMode);
        applyMode();

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            if (!files || !files.length) {
                alert("Please choose at least one file or folder.");
                return;
            }

            const category = categoryEl.value.trim();
            if (!category) {
                alert("Please choose a category.");
                return;
            }

            const mode = modeEl.value; // "folder" or "files"
            let subfolder = subfolderEl.value.trim().replace(/\/+$/, "");

            // If no subfolder was provided, infer from first file folder name ONLY in folder mode
            if (!subfolder && mode === "folder") {
                const firstPath = files[0].webkitRelativePath || "";
                subfolder = firstPath.split("/")[0] || "misc";
            }

            // For files mode with no subfolder, default to "misc"
            if (!subfolder && mode === "files") {
                subfolder = "misc";
            }

            const formData = new FormData();

            for (const file of files) {
                const relativePath = file.webkitRelativePath || file.name;

                // In folder mode, keep nested structure after the top-level folder.
                // In files mode, just use the filename.
                const cleanedPath =
                    mode === "folder"
                        ? relativePath.split("/").slice(1).join("/")
                        : file.name;

                const fullPath = `${category}/${subfolder}/${cleanedPath || file.name}`.replace(
                    /\/+/g,
                    "/"
                );

                formData.append(fullPath, file);
            }

            // ‚úÖ Notes as a plain field, NOT as a file
            const notesEl = document.getElementById("notes");
            const notes = notesEl && notesEl.value ? notesEl.value.trim() : "";
            if (notes) {
                formData.append("notes", notes);
            }

            statusEl.textContent = "Uploading‚Ä¶";
            resultEl.innerHTML = "";
            submitBtn.disabled = true;

            try {
                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    const list = (data.urls || [])
                        .map((u) => `<li><a href="${u}" target="_blank" rel="noreferrer">${u}</a></li>`)
                        .join("");
                    resultEl.innerHTML =
                        `<p>Uploaded ${(data.uploaded ?? data.urls?.length) || 0} files:</p><ul>${list}</ul>`;
                    statusEl.textContent = "Upload complete.";
                } else {
                    statusEl.textContent = "Upload failed.";
                    resultEl.textContent = data.error || "Server returned an error.";
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Upload error ‚Äì see console.";
                resultEl.textContent = "";
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</AdminLayout>

<style>
    .admin-title {
        margin: 0 0 8px;
        font-size: clamp(1.6rem, 2.2vw, 1.9rem);
    }

    .admin-subtitle {
        margin: 0 0 20px;
        color: #4b5563;
        font-size: 0.98rem;
    }

    .panel {
        border-radius: 18px;
        border: 1px solid #e5e7eb;
        padding: 16px;
        background: #f9fafb;
    }

    .admin-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .admin-form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
    }

    .admin-field-label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.9rem;
    }

    .admin-input {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 0.95rem;
        background: #fff;
    }

    .hint {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .actions-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-text {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .upload-result {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
        font-size: 0.9rem;
        max-height: 260px;
        overflow: auto;
    }

    .admin-btn {
        padding-inline: 18px;
    }
</style>

