---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";
import { verifyAdminToken } from "../../utils/adminToken";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;

const isAdmin = ADMIN_SECRET
    ? await verifyAdminToken(auth, ADMIN_SECRET)
    : false;

if (!isAdmin) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---

<AdminLayout title="Upload Images" description="Admin image upload management.">
    <h1 class="admin-title">Upload Images</h1>
    <p class="admin-subtitle">
        Upload new images to the R2 gallery bucket. You can upload a whole folder
        or individual files.
    </p>

    <section class="panel">
        <form id="admin-upload-form" class="admin-form-flex">
            <div class="admin-form-grid">

                <label class="admin-field-label">
                    <span>Category</span>
                    <select id="category" name="category" class="admin-input" required>
                        <option value="uploads">Uploads</option>
                        <option value="Projects">Projects</option>
                        <option value="Highlights">Highlights</option>
                        <option value="New Construction">New Construction</option>
                        <option value="Remodels">Remodels</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Apparel">Apparel</option>
                    </select>
                </label>

                <label class="admin-field-label">
                    <span>Images</span>
                    <input
                            id="fileInput"
                            type="file"
                            name="files"
                            multiple
                            accept="image/*"
                            capture="environment"
                            class="admin-input"
                    />
                    <small class="hint">
                        Choose one or more images from your gallery, or use the camera on
                        mobile. Files are stored under the selected category and subfolder.
                    </small>
                </label>
            </div>

            <label class="admin-field-label">
                <span>Subfolder (project / album name)</span>

                <div class="subfolder-row">
                    <select id="subfolder-select" class="admin-input">
                        <option value="">â€” Select folder â€”</option>
                        <option value="__NEW__">âž• Create new folderâ€¦</option>
                    </select>
                </div>

                <input
                        id="subfolder-custom"
                        type="text"
                        class="admin-input"
                        placeholder="Enter new folder nameâ€¦"
                        style="display:none;margin-top:8px;"
                />
                <small class="hint">
                    Leave subfolder blank to infer a name from the first file.
                    For Projects, this becomes the project folder and slug (Pfaffe House â†’ /projects/pfaffe-house/).
                    For all other categories, files go into a <code>misc</code> folder inside that category.
                </small>
            </label>

            <div class="actions-row">
                <button type="submit" class="btn admin-btn" id="submitBtn">
                    ðŸ“¤ Upload
                </button>
                <span id="status" class="status-text"></span>
            </div>

            <div id="result" class="upload-result"></div>
        </form>
    </section>
    <script>
        import initUploadPage from "./upload-script";
        initUploadPage();
    </script>
</AdminLayout>

