---
import AdminLayout from "../../layout/AdminLayout.astro";
import "../../styles/global.css";
import "../../styles/admin.css";
import { verifyAdminToken } from "../../utils/adminToken";

const cookies = Astro.cookies;
const auth = cookies.get("admin_auth")?.value || "";
const env = (Astro.locals as any).runtime?.env ?? {};
const ADMIN_SECRET = env.ADMIN_SECRET;
const SESSION_VERSION  = env.SESSION_VERSION ?? "1";

if (!ADMIN_SECRET || !SESSION_VERSION) {
    console.error("[admin] Missing ADMIN_SECRET or SESSION_VERSION in runtime env");
    return new Response("Something went wrong. Please try again later.", { status: 500 });
}

const isAdmin = auth && ADMIN_SECRET && SESSION_VERSION
    ? await verifyAdminToken(auth, ADMIN_SECRET, SESSION_VERSION)
    : false;

if (!isAdmin) {
    return new Response(null, {
        status: 302,
        headers: { Location: "/admin" },
    });
}
---
<AdminLayout title="Admin Dashboard" description="Admin dashboard.">
    <h1 class="admin-title">Admin Dashboard</h1>

    <nav class="admin-actions">
        <a href="/admin/upload" class="btn admin-btn">
            <span class="icon" aria-hidden="true">üì§</span>
            <span>Upload Images</span>
        </a>

        <a href="/admin/manage" class="btn admin-btn">
            <span class="icon" aria-hidden="true">üìÅ</span>
            <span>Manage Images</span>
        </a>

        <a href="/admin/reviews" class="btn admin-btn">
            <span class="icon" aria-hidden="true">üìù</span>
            <span>Moderate Reviews</span>
        </a>
        <a href="/admin/apparel" class="btn admin-btn">
            <span class="icon" aria-hidden="true">üëï</span>
            <span>Apparel Items</span>
        </a>
    </nav>
</AdminLayout>