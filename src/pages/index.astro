---
import MainLayout from "../layout/MainLayout.astro";
import "../styles/global.css";
import "../styles/hero.css";

type Highlight = {
    name: string;
    full: string;
    thumb: string;
};

type ReviewsSummary = {
    averageRating: number;
    totalReviews: number;
    ratingBreakdown: Record<number, number>;
};

type Review = {
    id: string;
    createdAt: string;
    rating: number;
    text: string;
    clientNamePublic: string;
    projectType: "new-construction" | "remodel" | "furniture" | "other";
    location?: string | null;
    photoUrl?: string | null;
    adminReply?: string | null;
    adminReplyAt?: string | null;
    featured?: boolean;
};

const { env } = Astro.locals.runtime;
const GALLERY_WORKER = env?.GALLERY_WORKER as Fetcher | undefined;
if (!GALLERY_WORKER) throw new Error("Missing service binding: GALLERY_WORKER");

let reviewsSummary: ReviewsSummary | null = null;
let homepageReviews: Review[] = [];
let highlights: Highlight[] = [];
let heroError: string | null = null;

async function workerFetchJsonWithRetry(binding: any, url: string, tries = 2): Promise<Response | null> {
    let last: Response | null = null;
    for (let i = 0; i < tries; i++) {
        try {
            const req = new Request(url, {
                method: "GET",
                headers: {
                    Accept: "application/json",
                    "Cache-Control": "no-store",
                    Pragma: "no-cache",
                },
                // @ts-expect-error: Cloudflare supports this in Workers
                cf: { cacheTtl: 0, cacheEverything: false },
            });
            const res = await binding.fetch(req);
            last = res;
            const ct = res.headers.get("content-type") || "";
            if (res.ok && ct.includes("application/json")) return res;
        } catch {
            // retry
        }
        await new Promise((r) => setTimeout(r, 150 * (i + 1)));
    }
    return last;
}

try {
    const res = await workerFetchJsonWithRetry(GALLERY_WORKER, "https://kilcon.work/api/gallery-api?list=highlights");
    if (!res || !res.ok) {
        heroError = "Failed to load highlights.";
    } else {
        const data = await res.json();
        const items = Array.isArray((data as any)?.items) ? (data as any).items : [];
        highlights = items
            .map((i: any) => ({
                name: String(i?.name ?? ""),
                full: String(i?.full ?? ""),
                thumb: String(i?.thumb ?? ""),
            }))
            .filter((h: Highlight) => !!h.full);
    }
} catch {
    heroError = "Failed to load highlights.";
}

try {
    const [summaryRes, listRes] = await Promise.all([
        workerFetchJsonWithRetry(GALLERY_WORKER, "https://kilcon.work/api/reviews/summary"),
        workerFetchJsonWithRetry(GALLERY_WORKER, "https://kilcon.work/api/reviews?page=1&pageSize=6")
    ]);

    if (summaryRes && summaryRes.ok) {
        reviewsSummary = await summaryRes.json();
    }

    if (listRes && listRes.ok) {
        const data = await listRes.json();
        homepageReviews = Array.isArray(data.reviews) ? data.reviews : [];
    }
} catch (e) {
    console.error("Failed to load reviews for homepage:", e);
}

// simple helper to turn "new-construction" -> "New construction"
function labelProjectType(type: Review["projectType"]): string {
    switch (type) {
        case "new-construction": return "New construction";
        case "remodel": return "Remodel";
        case "furniture": return "Furniture";
        default: return "Project";
    }
}

function truncate(text: string, max = 220): string {
    if (!text) return "";
    if (text.length <= max) return text;
    return text.slice(0, max - 1).trimEnd() + "…";
}

const heroCover = highlights[0]?.full;
const heroRotUrls = highlights.map((h) => h.full);

const localBusinessJsonLd = {
    "@context": "https://schema.org",
    "@type": ["GeneralContractor", "HomeAndConstructionBusiness"],
    "@id": "https://kilcon.work/#business",
    "name": "KIL Construction",
    "url": "https://kilcon.work/",
    "image": "https://kilcon.work/og/og-image_1200x630.jpg",
    "logo": "https://kilcon.work/brand/logo.png",
    "telephone": "+1-715-279-1241",
    "email": "kil.con.contact@gmail.com",
    "priceRange": "$$",
    "address": {
        "@type": "PostalAddress",
        "addressLocality": "Mondovi",
        "addressRegion": "WI",
        "postalCode": "54755",
        "addressCountry": "US"
    },
    "areaServed": [
        {
            "@type": "City",
            "name": "Mondovi",
            "address": {
                "@type": "PostalAddress",
                "addressRegion": "WI",
                "addressCountry": "US"
            }
        },
        {
            "@type": "AdministrativeArea",
            "name": "Western Wisconsin"
        }
    ],
    "contactPoint": [
        {
            "@type": "ContactPoint",
            "telephone": "+1-715-279-1241",
            "contactType": "customer service",
            "areaServed": "US",
            "availableLanguage": "English"
        }
    ],
    "sameAs": [
        "https://www.facebook.com/profile.php?id=61559555097375"
    ],
    "subjectOf": {
        "@type": "ImageObject",
        "contentUrl": "https://kilcon.work/brand/bizcard-front-new.jpg",
        "name": "KIL Construction business card"
    },
    "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Construction Services",
        "itemListElement": [
            {
                "@type": "Offer",
                "itemOffered": {
                    "@type": "Service",
                    "name": "New Construction",
                    "url": "https://kilcon.work/services/new-construction"
                }
            },
            {
                "@type": "Offer",
                "itemOffered": {
                    "@type": "Service",
                    "name": "Remodels",
                    "url": "https://kilcon.work/services/remodels"
                }
            },
            {
                "@type": "Offer",
                "itemOffered": {
                    "@type": "Service",
                    "name": "Custom Furniture & Cabinetry",
                    "url": "https://kilcon.work/services/furniture"
                }
            }
        ]
    }
};
---
<MainLayout
        title="KIL Construction | Custom Carpentry & Cabinets"
        description="Custom cabinetry, new construction, and remodeling by KIL Construction in Mondovi, WI."
        ogDescription="Custom cabinetry, new construction, and remodeling."
        twitterDescription="Custom cabinetry, new construction, and remodeling."
>
    <Fragment slot="head">
        <script type="application/ld+json" set:html={JSON.stringify(localBusinessJsonLd)} />
    </Fragment>

    <section class="hero">
        <div class="hero-copy">
            <h1>On-target workmanship. On-time results.</h1>
            <p>Hand-crafted cabinetry, new construction, and remodeling projects.</p>
        </div>
        <div class="hero-card">
            <div class="hero-image-wrap">
                {heroCover ? (
                    <a
                        class="rotatable"
                        href={heroCover}
                        target="_blank"
                        rel="noopener"
                    >
                        <img
                            class="photo hero-photo"
                            src={heroCover}
                            alt="KIL Construction project highlight"
                            data-rot-srcs={JSON.stringify(heroRotUrls)}
                        />
                    </a>
                ) : (
                    <div class="hero-placeholder">
                        KIL Construction
                    </div>
                )}
            </div>

            {heroError && (
                    <p class="hero-status status status--error">
                        Couldn’t load highlight photos right now.
                    </p>
            )}
        </div>
	</section>

	<section>
		<h2>What we do</h2>
		<section class="grid">
			<a class="card" href="/services/new-construction">
				<h3>New Construction</h3>
				<p>Framing, drywall, decks, siding, complete builds.</p>
			</a>

			<a class="card" href="/services/remodels">
				<h3>Remodels</h3>
				<p>Kitchens, baths, basements, doors/windows.</p>
			</a>

			<a class="card" href="/services/furniture">
				<h3>Furniture</h3>
				<p>Custom cabinetry, built-ins, tables, and trim.</p>
			</a>
		</section>
        <div class="services-info-row">
            <p class="svc svc-left">
                We provide estimates and guarantee our work.
            </p>

            <p class="svc svc-center">
                Have a custom project in mind?
                <a href="/contact" class="inline-link">Contact us.</a>
            </p>

            <p class="svc svc-right">
                Had a project done by us?
                <a href="/reviews#leave-review" class="inline-link">Leave a review.</a>
            </p>
        </div>
	</section>
    {reviewsSummary && reviewsSummary.totalReviews > 0 && (
        <section class="homepage-reviews">
            <div class="card card--reviews-shell">
                <h2 class="reviews-heading">Client reviews</h2>

                <div class="reviews-summary-row">
                    <div class="reviews-stars" aria-hidden="true">
                        {Array.from({ length: 5 }).map((_, i) => (
                                <span class={i < Math.round(reviewsSummary.averageRating) ? "star filled" : "star"}>★</span>
                        ))}
                    </div>
                    <p class="reviews-summary-text">
                        <strong>{reviewsSummary.averageRating} out of 5 stars</strong><br />
                        Based on {reviewsSummary.totalReviews} client reviews
                    </p>
                </div>

                <div class="reviews-strip" aria-label="Client reviews" role="list">
                    {homepageReviews.map((review: Review) => (
                        <a
                            href={`/reviews#review-${review.id}`}
                            class="review-card-link"
                            role="listitem"
                        >
                            <article class="card card--review-tile">
                                <header class="review-card-header">
                                    <h3 class="review-name">{review.clientNamePublic}</h3>
                                    <p class="review-meta">
                                        {labelProjectType(review.projectType)}
                                        {review.location && <> · {review.location}</>}
                                    </p>
                                    <div
                                        class="review-stars-row"
                                        aria-label={`${review.rating} out of 5 stars`}
                                    >
                                        {Array.from({ length: 5 }).map((_, i) => (
                                            <span class={i < review.rating ? "star filled" : "star"}>★</span>
                                        ))}
                                    </div>
                                </header>
                                    <p class="review-text">
                                        {truncate(review.text)}
                                    </p>

                                    {review.photoUrl && (
                                        <div class="review-photo-wrap">
                                            <img
                                                src={review.photoUrl}
                                                alt={`${review.clientNamePublic}'s ${labelProjectType(review.projectType)} project${review.location ? ` in ${review.location}` : ""}`}
                                                loading="lazy"
                                            />
                                        </div>
                                    )}
                            </article>
                        </a>
                    ))}
                </div>

                <div class="reviews-cta-row">
                    <a href="/reviews" class="inline-link">Read all reviews</a>
                </div>
            </div>
        </section>
    )}
    <script src="/js/rotator.js?v=14" defer></script>
    <script src="/js/grid-enhancer.js?v=7" defer></script>
</MainLayout>
