---
import MainLayout from '../../layout/MainLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { toCards } from "../../utils/projectCards";

const API = new URL('/api/gallery', Astro.url);

type ListResponse = { projects?: any[] };
type Card = ReturnType<typeof toCards>[number];

let cards: Card[]= [];
try {
    const u = new URL(API);
    u.searchParams.set('list', 'projects');
    const res = await fetch(u, { cache: 'no-store' });
    if (res.ok && res.headers.get('content-type')?.includes('application/json')) {
        const json = (await res.json()) as ListResponse;
        cards = toCards(json.projects ?? []);
    }
} catch {}
---

<MainLayout title="Projects">
    <h1 class="page-head container">Projects</h1>
    <section class="container page-section">
        <div class="grid grid--cards">
            {cards.map((c) => (
                <ProjectCard
                    p={c.p}
                    first={c.first}
                    src={c.src}
                    rotList={c.rotList}
                />
            ))}
        </div>
    </section>

    <!-- load the rotator -->
    <script src="/js/rotator.js" defer></script>
    <script src="/js/grid-enhancer.js" defer></script>
</MainLayout>