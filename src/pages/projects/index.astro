---
import MainLayout from '../../layout/MainLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import "../../styles/global.css";
import "../../styles/projects.css";


const PROD_ORIGIN = Astro.site?.origin || 'https://kilcon.work';
const API_BASE = import.meta.env.DEV ? 'https://kilcon.work' : PROD_ORIGIN;
const API = new URL('/api/gallery-api', API_BASE);

type ProjectFromApi = {
    slug: string;
    name: string;
    summary?: string;
    year?: string;
    location?: string;
    previews?: { thumb?: string; full?: string }[];
    images?: { thumb?: string; full?: string };
};

type Card = {
    p: {
        slug: string;
        name: string;
        summary?: string;
        year?: string;
        location?: string;
    };
    first?: { name?: string; url?: string } | string;
    src?: string;
    rotList: string[];
};

type ListResponse = { projects?: ProjectFromApi[] };

let cards: Card[] = [];
let loadError: string | null = null;

async function fetchJsonWithRetry(url: URL, tries = 3): Promise<Response | null> {
    let last: Response | null = null;

    for (let i = 0; i < tries; i++) {
        try {
            const res = await fetch(url, {
                cache: "no-store",
                headers: { Accept: "application/json" },
            });

            last = res;

            const ct = res.headers.get("content-type") || "";
            if (res.ok && ct.includes("application/json")) return res;
        } catch {
            // swallow and retry
        }

        await new Promise<void>((r) => setTimeout(r, 150 * (i + 1)));
    }

    return last;
}

function isJson(res: Response) {
    return (res.headers.get("content-type") || "").includes("application/json");
}

try {
    const u = new URL(API);
    u.searchParams.set('list', 'projects');

    let res = await fetchJsonWithRetry(u, 3);

    if (!res || !res.ok || res.status === 404 || !isJson(res)) {
        const fallback = new URL('/api/gallery-api', 'https://kilcon.work');
        fallback.searchParams.set('list', 'projects');
        res = await fetchJsonWithRetry(fallback, 3);
    }
    if (!res || !res.ok || !isJson(res)) {
        loadError = "Failed to load projects.";
    } else {
        const json = (await res.json()) as ListResponse;
        const projects = json.projects ?? [];

        cards = projects.map((proj) => {
            const previews = proj.previews ?? [];
            const firstPreview = previews[0];

            // choose a cover image for the card
            const cover =
                proj.images?.thumb ||
                proj.images?.full ||
                firstPreview?.thumb ||
                firstPreview?.full;

            // list of images for the rotator
            const rotList = previews
                .map((p) => p.thumb || p.full)
                .filter((u): u is string => !!u);

            return {
                p: {
                    slug: proj.slug,
                    name: proj.name,
                    summary: proj.summary,
                    year: proj.year,
                    location: proj.location,
                },
                first: firstPreview
                    ? {
                        name: firstPreview.full?.split('/').pop() ?? '',
                        url: firstPreview.thumb || firstPreview.full,
                    }
                    : undefined,
                src: cover,
                rotList,
            };
        });
    }
} catch { loadError = 'Failed to load projects.'; }

function hasUrl(x: unknown): x is { url: string } {
    return !!x && typeof (x as any).url === 'string';
}
---

<MainLayout title="Projects | KIL Construction"  description="Browse recent KIL Construction projects, including kitchens, built-ins, and more.">
    <Fragment slot="head">

        {(() => {
            const withWidth = (u: string, w: number): string =>
                u.replace(
                    /\/cdn-cgi\/image\/width=\d+/,
                    `/cdn-cgi/image/width=${w}`
                );

            return cards.slice(0, 6).map((c) => {
                if (!c.src) return null;

                return (
                    <link
                        rel="preload"
                        as="image"
                        href={withWidth(c.src, 600)}
                        imagesrcset={`${withWidth(c.src, 600)} 600w, ${withWidth(c.src, 1200)} 1200w, ${withWidth(c.src, 2000)} 2000w`}
                        imagesizes="680px"
                    />
                );
            });
        })()}
    </Fragment>
    <h1 class="page-head container">Projects</h1>
    <section class="container page-section">
        {loadError && (
            <p class="status status--error">
                Couldnâ€™t load projects right now. Please try again later.
            </p>
        )}

        {!loadError && cards.length === 0 && (
            <p class="status status--empty">
                No projects yet. Check back soon.
            </p>
        )}

        {!loadError && cards.length > 0 && (
            <div class="grid grid--projects">
                {cards.map((c, i) => (
                    <ProjectCard
                        p={c.p}
                        first={c.first}
                        src={c.src}
                        rotList={c.rotList}
                        eager={i < 6}
                        cover={c.src ?? (hasUrl(c.first) ? c.first.url : undefined)}
                    />
                ))}
            </div>
        )}
    </section>
    <script src="/js/rotator.js?v=14" defer></script>
    <script src="/js/grid-enhancer.js?v=7" defer></script>
</MainLayout>