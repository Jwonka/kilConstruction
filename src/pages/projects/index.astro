---
import MainLayout from '../../layout/MainLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { toCards, type Project } from '../../utils/projectCards';

const api = import.meta.env.PUBLIC_GALLERY_API as string | undefined;

let projects: Project[] = [];
let loadError: string | null = null;

if (!api) {
    loadError = 'Missing PUBLIC_GALLERY_API';
} else {
    try {
        const res = await fetch(`${api}?list=projects`, { cache: 'force-cache' });
        if (!res.ok) {
            loadError = `HTTP ${res.status}`;
        } else if (!res.headers.get('content-type')?.includes('application/json')) {
            loadError = 'Bad response (not JSON)';
        } else {
            const json = (await res.json()) as { projects?: Project[] };
            projects = json.projects ?? [];
        }
    } catch (e: any) {
        loadError = e?.message ?? 'Network error';
    }
}

const cards = toCards(projects);
---

<MainLayout title="Projects">
    <h1 class="page-head container">Projects</h1>
    <section class="container page-section grid-cards projects-page">
        {loadError && <p class="error">Failed to load: {loadError}</p>}
        {cards.length > 0 &&
            cards.map(({ p, first, src, rotList }) => (
                    <ProjectCard p={p} first={first} src={src} rotList={rotList} />
            ))
        }
        {!loadError && cards.length === 0 && <p>No images uploaded yet.</p>}
    </section>
    <script src="/js/rotator.js" is:inline></script>
</MainLayout>