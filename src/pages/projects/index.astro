---
import MainLayout from '../../layout/MainLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { toCards, type Project } from '../../utils/projectCards';

const api = import.meta.env.PUBLIC_GALLERY_API as string;

let projects: Project[] = [];
let loadError: string | null = null;

try {
    const res = await fetch(`${api}?list=projects`, { cache: 'force-cache' });
    if (res.ok) {
        const json = (await res.json()) as { projects?: Project[] };
        projects = json.projects ?? [];
    } else {
        loadError = `HTTP ${res.status}`;
    }
} catch (e: any) {
    loadError = e?.message ?? 'Network error';
}

const cards = toCards(projects);
---

<MainLayout title="Projects">
    <section class="grid-cards">
        {loadError && <p class="error">Failed to load: {loadError}</p>}

        {cards.length > 0 &&
            cards.map(({ p, first, src, rotList }) => (
                    <ProjectCard p={p} first={first} src={src} rotList={rotList} />
            ))}

        {!loadError && cards.length === 0 && (
                <p>No images uploaded yet.</p>
        )}
    </section>

    <script src="/js/rotator.js" is:inline></script>
</MainLayout>