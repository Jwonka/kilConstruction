---
import MainLayout from '../../layout/MainLayout.astro';
import type { Project } from '../../utils/projectCards';

type Photo = {
    id: string;
    name: string;
    thumb: string;
    full: string;
    createdTime: string;
    };

export const prerender = true;

/** Build-time: tell Astro which /projects/:slug pages exist */
export async function getStaticPaths() {
    const base = import.meta.env.PUBLIC_GALLERY_API as string | undefined;
    if (!base) return [];

    const res = await fetch(`${base}?list=projects`, { cache: 'force-cache' });

    if (!res.ok) {
        console.warn(`getStaticPaths: HTTP ${res.status}`);
        return [];
    }
    if (!res.headers.get('content-type')?.includes('application/json')) {
        console.warn('getStaticPaths: bad response (not JSON)');
        return [];
    }

    const json = (await res.json()) as { projects?: Project[]; error?: string; message?: string };
    if (json.error) {
        console.warn(`getStaticPaths: ${json.message || json.error}`);
        return [];
    }
    const projects = json.projects ?? [];
    return projects.map((p) => ({ params: { slug: p.slug }, props: { slug: p.slug } }));
    }

const { slug } = Astro.params;

let items: Photo[] = [];
let loadError: string | null = null;

try {
    const base = import.meta.env.PUBLIC_GALLERY_API as string | undefined;
    if (!base) {
        console.warn('PUBLIC_GALLERY_API missing, no project pages will be built.');
        return [];
    }

    const res = await fetch(`${base}?project=${slug}`, { cache: 'force-cache' });
    if (!res.ok) {
        loadError = `HTTP ${res.status}`;
    } else if (!res.headers.get('content-type')?.includes('application/json')) {
        loadError = 'Bad response (not JSON)';
    } else {
        const json = (await res.json()) as { items?: Photo[]; error?: string; message?: string };
        if (json.error) {
            loadError = json.message || json.error;
        } else {
            items = json.items ?? [];
        }
    }
} catch (e: any) {
    loadError = e?.message ?? 'Network error';
}

const sized = (url: string, w = 2000) => url.replace(/=s0$/, `=w${w}`);
---

<MainLayout title="Project">
    <section class="gallery grid-cards">
        {loadError && <p class="error">Failed to load photos: {loadError}</p>}
        {items.length > 0 ? (
            items.map((i) => (
                    <a class="card card-photo" href={sized(i.full)} target="_blank" rel="noopener">
                        <img
                                class="photo"
                                loading="lazy"
                                decoding="async"
                                referrerpolicy="no-referrer"
                                src={i.thumb || i.full}
                                alt={i.name}
                        />
                    </a>
            ))
        ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}
    </section>
</MainLayout>