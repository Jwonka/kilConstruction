---
import MainLayout from '../../layout/MainLayout.astro';
import "../../styles/global.css";
import "../../styles/projects.css";

export const prerender = false;

const API_ORIGIN = 'https://kilcon.work';
const API = new URL('/api/gallery-api', API_ORIGIN);

type Photo = {
    id: string;
    name: string;
    thumb: string;
    full: string;
    createdTime: string;
    description?: string;
    };

const { slug } = Astro.params as { slug: string };

let items: Photo[] = [];
let loadError: string | null = null;
let projectName = slug.replace(/-/g, ' ').replace(/\b\w/g, s => s.toUpperCase());
let projectDesc: string | undefined;

try {
    const API_ORIGIN = 'https://kilcon.work';
    const API = new URL('/api/gallery-api', API_ORIGIN);
    // Fetch album items
    const apiItems = new URL(API);
    apiItems.searchParams.set('project', slug);
    const r1 = await fetch(apiItems, { cache: 'no-store' });
    if (!r1.ok) {
        loadError = `HTTP ${r1.status}`;
    } else if (!r1.headers.get('content-type')?.includes('application/json')) {
        loadError = 'Bad response (not JSON)';
    } else {
        const j1 = (await r1.json()) as { items?: Photo[]; project?: { name?: string; description?: string } };
        items = j1.items ?? [];
        items.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
        if (j1.project?.name) projectName = j1.project.name;
        if (j1.project?.description) projectDesc = j1.project.description;
    }

    // Optionally look up friendly name/description from the projects list
    if (!projectDesc) {
        const apiList = new URL(API);
        apiList.searchParams.set('list', 'projects');
        const r2 = await fetch(apiList, { cache: 'no-store' });
        if (r2.ok && r2.headers.get('content-type')?.includes('application/json')) {
            const j2 = (await r2.json()) as { projects?: { slug: string; name?: string; description?: string }[] };
            const m = j2.projects?.find(p => p.slug === slug);
            if (m?.name) projectName = m.name;
            if (m?.description) projectDesc = m.description;
        }
    }
} catch (e: any) {
    loadError = e?.message ?? 'Network error';
}

const cropName = (s: string) =>
    s
        .replace(/\.[^.]+$/, "")        // remove extension
        .replace(/[_]+/g, " ")          // underscores -> spaces
        .replace(/^\s*\d+[\s_-]*/, "")  // strip leading digits + separators
        .replace(/[\s_-]*\d+\s*$/, "")  // strip trailing digits + separators
        .trim();
const metaDescription =
    projectDesc
        ? `${projectName} – ${projectDesc}`
        : `${projectName} from KIL Construction – view project photos and details.`;
---

<MainLayout title={projectName} description={metaDescription} noSticky>
    <h1 class="page-head container">{projectName}</h1>
    {projectDesc && <p class="container muted" style="margin-top:-6px;margin-bottom:14px;">{projectDesc}</p>}

    <section class="container page-section">
        {items.length > 0 ? (
            <div class="grid grid--projects">
                {items.map((i, index) => {
                    // Start the base label with the project name
                    const base = projectName;

                    // Clean filename using your existing helper
                    let cleanedName = cropName(i.name);
                    cleanedName = cleanedName.replace(/^(IMG|DSC)[-_]*/i, "").trim();

                    // Prefer the image's description for alt (not visible caption)
                    const sceneLabel =
                        (i.description && i.description.trim()) ||
                        cleanedName ||
                        `project photo ${index + 1}`;

                    const alt = `${base} – ${sceneLabel}`;

                    return (
                            <figure class="card card-media">
                                <a href={i.full || i.thumb} target="_blank" rel="noopener">
                                    <img
                                        class="photo"
                                        loading="lazy"
                                        decoding="async"
                                        referrerpolicy="no-referrer"
                                        src={i.thumb || i.full}
                                        srcset={`${(i.thumb || i.full).replace('=s0','=w600')} 600w, ${(i.thumb || i.full).replace('=s0','=w1200')} 1200w, ${(i.thumb || i.full).replace('=s0','=w2000')} 2000w`}
                                        alt={alt}
                                        sizes="(max-width: 560px) 90vw, (max-width: 1200px) 45vw, 28vw"
                                    />
                                </a>
                                {(i.description || i.name) && (
                                        <figcaption class="caption">
                                            {i.description || cropName(i.name)}
                                        </figcaption>
                                )}
                            </figure>
                    );
                })}
            </div>
    ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}
        {loadError && <p class="error">Failed to load: {loadError}</p>}
    </section>
</MainLayout>