---
import MainLayout from '../../layout/MainLayout.astro';

type Photo = {
    id: string;
    name: string;
    thumb: string;
    full: string;
    createdTime: string;
    };

export const prerender = true;

/** Build-time: tell Astro which /projects/:slug pages exist */
export async function getStaticPaths() {
    const base = import.meta.env.PUBLIC_GALLERY_API as string | undefined;

    // If missing, skip building any /projects/[slug] pages
    if (!base) {
        console.warn('getStaticPaths: PUBLIC_GALLERY_API missing; skipping project pages.');
        return [];
    }

    // Validate it's an absolute URL BEFORE using it
    let api: URL;
    try {
        api = new URL(base); // throws if not absolute (e.g., '', 'undefined', '***')
    } catch (e) {
        console.warn('getStaticPaths: PUBLIC_GALLERY_API is not a valid URL; skipping.');
        return [];
    }

    try {
        api.searchParams.set('list', 'projects');
        const res = await fetch(api, { cache: 'no-store' });

        if (!res.ok) {
            console.warn(`getStaticPaths: HTTP ${res.status}; skipping.`);
            return [];
        }
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
            console.warn('getStaticPaths: non-JSON response; skipping.');
            return [];
        }

        const json = (await res.json()) as { projects?: { slug: string }[]; error?: string; message?: string };
        if (json.error) {
            console.warn('getStaticPaths:', json.message || json.error);
            return [];
        }

        const projects = json.projects ?? [];
        return projects.map((p) => ({ params: { slug: p.slug }, props: { slug: p.slug } }));
    } catch (err) {
        console.warn('getStaticPaths: fetch failed; skipping.', err);
        return [];
    }
}

const { slug } = Astro.params;

let items: Photo[] = [];
let loadError: string | null = null;

try {
    const base = import.meta.env.PUBLIC_GALLERY_API as string | undefined;
    if (!base) {
        loadError = 'Missing PUBLIC_GALLERY_API';
    } else {
        // validate URL and build ?project param safely
        let api: URL;
        try {
            api = new URL(base);
            api.searchParams.set('project', slug);
        } catch {
            loadError = 'Bad API URL';
        }

        if (!loadError) {
            const res = await fetch(api!, { cache: 'force-cache' });
            if (!res.ok) {
                loadError = `HTTP ${res.status}`;
            } else if (!res.headers.get('content-type')?.includes('application/json')) {
                loadError = 'Bad response (not JSON)';
            } else {
                const json = (await res.json()) as { items?: Photo[]; error?: string; message?: string };
                if (json.error) loadError = json.message || json.error;
                else items = json.items ?? [];
            }
        }
    }
} catch (e: any) {
    loadError = e?.message ?? 'Network error';
}
const sized = (url: string, w = 2000) => url.replace(/=s0$/, `=w${w}`);
---

<MainLayout title="Project">
    <section class="gallery grid-cards">
        {loadError && <p class="error">Failed to load photos: {loadError}</p>}
        {items.length > 0 ? (
            items.map((i) => (
                    <a class="card card-photo" href={sized(i.full)} target="_blank" rel="noopener">
                        <img
                                class="photo"
                                loading="lazy"
                                decoding="async"
                                referrerpolicy="no-referrer"
                                src={i.thumb || i.full}
                                alt={i.name}
                        />
                    </a>
            ))
        ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}
    </section>
</MainLayout>