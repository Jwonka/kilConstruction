---
import MainLayout from '../../layout/MainLayout.astro';

type Photo = {
    id: string;
    name: string;
    thumb: string;
    full: string;
    createdTime: string;
    description?: string;
    };

export const prerender = true;

/** Build-time: tell Astro which /projects/:slug pages exist */
export async function getStaticPaths() {
    const API = 'https://kilcon.work/api/gallery';

    // If missing, skip building any /projects/[slug] pages
    if (!API) {
        console.warn('getStaticPaths: PUBLIC_GALLERY_API missing; skipping project pages.');
        return [];
    }

    // Validate it's an absolute URL BEFORE using it
    let api: URL;
    try {
        api = new URL(API);
    } catch (e) {
        console.warn('getStaticPaths: PUBLIC_GALLERY_API is not a valid URL; skipping.');
        return [];
    }

    try {
        api.searchParams.set('list', 'projects');
        const res = await fetch(api, { cache: 'no-store' });

        if (!res.ok) {
            console.warn(`getStaticPaths: HTTP ${res.status}; skipping.`);
            return [];
        }
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
            console.warn('getStaticPaths: non-JSON response; skipping.');
            return [];
        }

        const json = (await res.json()) as { projects?: { slug: string }[]; error?: string; message?: string };
        if (json.error) {
            console.warn('getStaticPaths:', json.message || json.error);
            return [];
        }

        const projects = json.projects ?? [];
        return projects.map((p) => ({ params: { slug: p.slug }, props: { slug: p.slug } }));
    } catch (err) {
        console.warn('getStaticPaths: fetch failed; skipping.', err);
        return [];
    }
}

const { slug } = Astro.params;

let items: Photo[] = [];
let loadError: string | null = null;
let projectName: string = slug!.replace(/-/g, ' ').replace(/\b\w/g, s => s.toUpperCase());
let projectDesc: string | undefined;

try {
    const API = 'https://kilcon.work/api/gallery';
    if (!API) {
        loadError = 'Missing PUBLIC_GALLERY_API';
    } else {
        // validate URL and build ?project param safely
        let api: URL;
        try {
            api = new URL(API);
        } catch {
            throw new Error('Bad API URL');
        }

        const apiItems = new URL(api);
        apiItems.searchParams.set('project', slug!);
        const res = await fetch(apiItems, { cache: 'force-cache' });

        if (!res.ok) loadError = `HTTP ${res.status}`;
        else if (!res.headers.get('content-type')?.includes('application/json')) loadError = 'Bad response (not JSON)';
        else {
            const json = (await res.json()) as { items?: Photo[]; project?: { name?: string; description?: string } };
            items = json.items ?? [];
            if (json.project?.name) projectName = json.project.name;
            if (json.project?.description) projectDesc = json.project.description;
        }

        if (!projectDesc) {
            const apiList = new URL(api);
            apiList.searchParams.set('list', 'projects');
            const res2 = await fetch(apiList, { cache: 'force-cache' });
            if (res2.ok && res2.headers.get('content-type')?.includes('application/json')) {
                const j2 = (await res2.json()) as { projects?: { slug: string; name?: string; description?: string }[] };
                const m = j2.projects?.find(p => p.slug === slug);
                if (m?.name) projectName = m.name;
                if (m?.description) projectDesc = m.description;
            }
        }
    }
} catch (e: any) {
    loadError = e?.message ?? 'Network error';
}
// noinspection JSUnusedGlobalSymbols
const sized = (url: string, w = 2000) => url.replace(/=s0$/, `=w${w}`);
const cropName = (s: string) => s.replace(/\.[^.]+$/, '').replace(/_/g, ' ');
---

<MainLayout title={projectName} noSticky>
    <h1 class="page-head container">{projectName}</h1>
    {projectDesc && <p class="container muted" style="margin-top:-6px;margin-bottom:14px;">{projectDesc}</p>}

    <section class="container page-section">
        {items.length > 0 ? (
            <div class="grid grid--album">
                {items.map((i) => (
                    <figure class="card card-media">
                        <img
                            class="photo"
                            loading="lazy"
                            decoding="async"
                            referrerpolicy="no-referrer"
                            src={i.thumb || i.full}
                            alt={i.name}
                            sizes="(max-width: 560px) 90vw, (max-width: 1200px) 45vw, 28vw" />
                        {(i.description || i.name) && (
                            <figcaption class="caption">{i.description || cropName(i.name)}</figcaption>
                        )}
                    </figure>
                ))}
            </div>
    ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}
        {loadError && <p class="error">Failed to load: {loadError}</p>}
    </section>
</MainLayout>