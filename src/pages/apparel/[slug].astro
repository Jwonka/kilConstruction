---
import MainLayout from "../../layout/MainLayout.astro";
import "../../styles/global.css";
import "../../styles/projects.css";

export const prerender = false;

const API_ORIGIN = "https://kilcon.work";
const API = new URL("/api/gallery-api", API_ORIGIN);

type Photo = {
    name: string;
    thumb: string;
    full: string;
    description?: string;
};

type ProjectMeta = {
    name?: string;
    description?: string;
};

const { slug } = Astro.params as { slug: string };

let items: Photo[] = [];
let loadError: string | null = null;
let albumName: string = slugToTitle(slug);
let albumDesc: string | undefined;

try {
    // 1) Apparel-specific request
    const apiItems = new URL(API);
    apiItems.searchParams.set("project", `apparel/${slug}`);
    const r1 = await fetch(apiItems, { cache: "no-store" });

    if (!r1.ok) {
        if (r1.status !== 404) {
            loadError = `HTTP ${r1.status}`;
        }
    } else if (!r1.headers.get("content-type")?.includes("application/json")) {
        loadError = "Bad response (not JSON)";
    } else {
        const j1 = (await r1.json()) as { items?: Photo[]; project?: ProjectMeta };
        items = j1.items ?? [];
        items.sort((a, b) =>
            a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: "base" }),
        );

        if (j1.project?.name) albumName = j1.project.name;
        if (j1.project?.description) albumDesc = j1.project.description;
    }

    // 2) optional meta from apparel list
    if (!albumDesc) {
        const apiList = new URL(API);
        apiList.searchParams.set("list", "apparel");

        const r2 = await fetch(apiList, { cache: "no-store" });
        if (r2.ok && r2.headers.get("content-type")?.includes("application/json")) {
            const j2 = (await r2.json()) as {
                apparel?: { slug: string; name?: string; description?: string }[];
                projects?: { slug: string; name?: string; description?: string }[];
            };

            const list = j2.apparel ?? j2.projects ?? [];
            const m = list.find((p) => p.slug === slug);
            if (m?.name) albumName = m.name;
            if (m?.description) albumDesc = m.description;
        }
    }
} catch (e: any) {
    loadError = e?.message ?? "Network error";
}

const cropName = (s: string) =>
    s
        .replace(/\.[^.]+$/, "")        // remove extension
        .replace(/[_]+/g, " ")          // underscores -> spaces
        .replace(/^\s*\d+[\s_-]*/, "")  // strip leading digits + separators
        .replace(/[\s_-]*\d+\s*$/, "")  // strip trailing digits + separators
        .trim();

function slugToTitle(s: string): string {
    return s
        .split("-")
        .filter(Boolean)
        .map((part) => part[0]?.toUpperCase() + part.slice(1))
        .join(" ");
}
const metaDescription =
    albumDesc
        ? `${albumName} – ${albumDesc}`
        : `${albumName} from KIL Construction – view styles and request an order.`;
---

<MainLayout title={albumName} description={metaDescription} noSticky>
    <h1 class="page-head container">{albumName}</h1>

    {albumDesc && (
            <p class="container muted" style="margin-top:-6px;margin-bottom:14px;">
                {albumDesc}
            </p>
    )}

    <section class="container page-section">
        {items.length > 0 ? (
            <div class="grid grid--projects">
                {items.map((i, index) => {
                    // 1) Base: service/album name in this page
                    const base = albumName;

                    // 2) Start from your existing filename helper (cropName)
                    let cleanedName = cropName ? cropName(i.name) : i.name;

                    // 3) Strip leading IMG_/DSC_ etc.
                    cleanedName = cleanedName.replace(/^(IMG|DSC)[-_]*/i, "").trim();

                    // 4) Prefer item description; fall back to cleaned filename; then to a generic label
                    const sceneLabel =
                        (i.description && i.description.trim()) ||
                        cleanedName ||
                        `project photo ${index + 1}`;

                    const alt = `${base} – ${sceneLabel}`;

                    return (
                        <figure class="card card-media">
                            <a href={i.full || i.thumb} target="_blank" rel="noopener">
                                <img
                                    class="photo"
                                    loading="lazy"
                                    decoding="async"
                                    referrerpolicy="no-referrer"
                                    src={i.thumb || i.full}
                                    srcset={`${(i.thumb || i.full).replace('=s0','=w600')} 600w, ${(i.thumb || i.full).replace('=s0','=w1200')} 1200w, ${(i.thumb || i.full).replace('=s0','=w2000')} 2000w`}
                                    alt={alt}
                                    sizes="(max-width: 560px) 90vw, (max-width: 1200px) 45vw, 28vw"
                                />
                            </a>
                            {(i.description || i.name) && (
                                <figcaption class="caption">
                                    {i.description || cropName(i.name)}
                                </figcaption>
                            )}
                        </figure>
                    );
                })}
            </div>
        ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}

        {loadError && <p class="error">Failed to load: {loadError}</p>}
    </section>

    {/* Apparel order form */}
    <section class="container page-section">
        <h2>Order {albumName}</h2>

        <div class="apparel-intro">
            <p id="order-success" class="status status--success hidden" aria-live="polite">
                Thanks! We’ll be in touch about your {albumName} order.
            </p>
            <p id="order-error" class="status status--error hidden" aria-live="polite">
                <!-- text set by script -->
            </p>
            <p class="section-intro">
                Fill out the form below to purchase a {albumName}.
            </p>
            <p class="section-intro">
                We’ll follow up by email to confirm pricing and availability.
            </p>
        </div>

        <p id="form-status" class="status" aria-live="polite"></p>

        <form method="POST" action="/api/contact">
            <label>
                Item
                <input type="text" name="itemName" value={slug} readonly />
            </label>

            <label>
                Size / color / variant
                <input type="text" name="itemVariant" placeholder="e.g. Large hoodie, black" />
            </label>

            <label>
                Quantity
                <input type="number" name="itemQuantity" min="1" value="1" />
            </label>

            <label>
                Your name
                <input type="text" name="name" required />
            </label>

            <label>
                Email
                <input type="email" name="email" required />
            </label>

            <label>
                Phone
                <input type="tel" name="phone" />
            </label>

            <label>
                Shipping address
                <input type="text" name="address" />
            </label>

            <label>
                Notes
                <textarea name="message" rows="3" placeholder="Anything else we should know?"></textarea>
            </label>

            {/* Turnstile field – keep the name consistent with handleContact */}
            <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response" />

            <button type="submit" class="btn cta">Submit order request</button>
        </form>
    </section>
    <script is:inline>
        (function () {
            const url = new URL(window.location.href);
            const params = url.searchParams;
            const sent = params.get("sent");
            const err  = params.get("err");

            const successEl = document.getElementById("order-success");
            const errorEl   = document.getElementById("order-error");

            if (sent === "1" && successEl) {
                successEl.classList.remove("hidden");
            } else if (err && errorEl) {
                errorEl.textContent =
                    err === "captcha"
                        ? "Please complete the CAPTCHA and try again."
                        : "Sorry, something went wrong. Please try again.";
                errorEl.classList.remove("hidden");
            }

            if (sent || err) {
                url.searchParams.delete("sent");
                url.searchParams.delete("err");
                window.history.replaceState(
                    null,
                    "",
                    url.pathname + url.search + window.location.hash
                );
            }
        })();
    </script>
</MainLayout>
