---
import MainLayout from "../../layout/MainLayout.astro";
import "../../styles/global.css";
import "../../styles/projects.css";

export const prerender = false;

const API_ORIGIN = "https://kilcon.work";
const API = new URL("/api/gallery-api", API_ORIGIN);

type Photo = {
    name: string;
    thumb: string;
    full: string;
    description?: string;
};

type ProjectMeta = {
    name?: string;
    description?: string;
};

const { slug } = Astro.params as { slug: string };

let items: Photo[] = [];
let loadError: string | null = null;
let albumName: string = slugToTitle(slug);
let albumDesc: string | undefined;

try {
    // 1) Apparel-specific request
    const apiItems = new URL(API);
    apiItems.searchParams.set("project", `apparel/${slug}`);
    const r1 = await fetch(apiItems, { cache: "no-store" });

    if (!r1.ok) {
        if (r1.status !== 404) {
            loadError = `HTTP ${r1.status}`;
        }
    } else if (!r1.headers.get("content-type")?.includes("application/json")) {
        loadError = "Bad response (not JSON)";
    } else {
        const j1 = (await r1.json()) as { items?: Photo[]; project?: ProjectMeta };
        items = j1.items ?? [];
        items.sort((a, b) =>
            a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: "base" }),
        );

        if (j1.project?.name) albumName = j1.project.name;
        if (j1.project?.description) albumDesc = j1.project.description;
    }

    // 2) optional meta from apparel list
    if (!albumDesc) {
        const apiList = new URL(API);
        apiList.searchParams.set("list", "apparel");

        const r2 = await fetch(apiList, { cache: "no-store" });
        if (r2.ok && r2.headers.get("content-type")?.includes("application/json")) {
            const j2 = (await r2.json()) as {
                apparel?: { slug: string; name?: string; description?: string }[];
                projects?: { slug: string; name?: string; description?: string }[];
            };

            const list = j2.apparel ?? j2.projects ?? [];
            const m = list.find((p) => p.slug === slug);
            if (m?.name) albumName = m.name;
            if (m?.description) albumDesc = m.description;
        }
    }
} catch (e: any) {
    loadError = e?.message ?? "Network error";
}

const cropName = (s: string) =>
    s
        .replace(/\.[^.]+$/, "")        // remove extension
        .replace(/[_]+/g, " ")          // underscores -> spaces
        .replace(/^\s*\d+[\s_-]*/, "")  // strip leading digits + separators
        .replace(/[\s_-]*\d+\s*$/, "")  // strip trailing digits + separators
        .trim();

function slugToTitle(s: string): string {
    return s
        .split("-")
        .filter(Boolean)
        .map((part) => part[0]?.toUpperCase() + part.slice(1))
        .join(" ");
}
const metaDescription =
    albumDesc
        ? `${albumName} – ${albumDesc}`
        : `${albumName} from KIL Construction – view styles and request an order.`;
---

<MainLayout title={albumName} description={metaDescription} noSticky>
    <h1 class="page-head container">{albumName}</h1>

    {albumDesc && (
            <p class="container muted" style="margin-top:-6px;margin-bottom:14px;">
                {albumDesc}
            </p>
    )}

    <section class="container page-section">
        {items.length > 0 ? (
            <div class="grid grid--projects">
                {items.map((i, index) => {
                    // 1) Base: service/album name in this page
                    const base = albumName;

                    // 2) Start from your existing filename helper (cropName)
                    let cleanedName = cropName ? cropName(i.name) : i.name;

                    // 3) Strip leading IMG_/DSC_ etc.
                    cleanedName = cleanedName.replace(/^(IMG|DSC)[-_]*/i, "").trim();

                    // 4) Prefer item description; fall back to cleaned filename; then to a generic label
                    const sceneLabel =
                        (i.description && i.description.trim()) ||
                        cleanedName ||
                        `project photo ${index + 1}`;

                    const alt = `${base} – ${sceneLabel}`;

                    return (
                        <figure class="card card-media">
                            <a href={i.full || i.thumb} target="_blank" rel="noopener">
                                <img
                                    class="photo"
                                    loading="lazy"
                                    decoding="async"
                                    referrerpolicy="no-referrer"
                                    src={i.thumb || i.full}
                                    srcset={`${(i.thumb || i.full).replace('=s0','=w600')} 600w, ${(i.thumb || i.full).replace('=s0','=w1200')} 1200w, ${(i.thumb || i.full).replace('=s0','=w2000')} 2000w`}
                                    alt={alt}
                                    sizes="(max-width: 560px) 90vw, (max-width: 1200px) 45vw, 28vw"
                                />
                            </a>
                            {(i.description || i.name) && (
                                <figcaption class="caption">
                                    {i.description || cropName(i.name)}
                                </figcaption>
                            )}
                        </figure>
                    );
                })}
            </div>
        ) : (
            !loadError && <p>No images uploaded yet.</p>
        )}

        {loadError && <p class="error">Failed to load: {loadError}</p>}
    </section>

    {/* Apparel order form */}
    <section class="container page-section">
        <h2 style="text-align: center;">Order {albumName}</h2>

        <p id="form-status" class="status" aria-live="polite"></p>

        <form id="checkoutForm" class="apparel-form">
            <label for="sizeSelect">Size</label>

            <select id="sizeSelect" name="size" required disabled>
                <option value="">Loading sizes…</option>
            </select>

            <p id="stockLine" class="muted" aria-live="polite"></p>

            <label for="qtyInput">Quantity</label>
            <input id="qtyInput" name="quantity" type="number" min="1" value="1" />

            <p id="checkoutError" class="status" aria-live="polite"></p>

            <p class="muted" style="margin-top:-6px;">
                Need a different size? <a id="requestSizeLink" href="/contact">Contact us</a>.
            </p>

            <div class="apparel-buttons">
                <button id="checkoutBtn" type="submit" class="btn cta">Checkout</button>

                <button class="btn cta">
                    <a href="/apparel">Back to apparel</a>
                </button>
            </div>
        </form>
    </section>
    <script is:inline define:vars={{ slug }}>

        const form = document.getElementById("checkoutForm");
        const sizeSelect = document.getElementById("sizeSelect");
        const qtyInput = document.getElementById("qtyInput");
        const stockLine = document.getElementById("stockLine");
        const checkoutBtn = document.getElementById("checkoutBtn");
        const checkoutError = document.getElementById("checkoutError");
        const requestSizeLink = document.getElementById("requestSizeLink");

        let variants = []; // [{size, priceCents, stock, active}]

        function centsToDollars(cents) {
            return (Number(cents || 0) / 100).toFixed(2);
        }

        function setError(msg) {
            checkoutError.textContent = msg || "";
        }

        function selectedVariant() {
            return variants.find(v => v.size === sizeSelect.value) || null;
        }

        function optionLabel(v) {
            const stock = Number(v.stock || 0);
            const active = Number(v.active || 0);
            if (active !== 1) return `${v.size} (unavailable)`;
            if (stock <= 0) return `${v.size} (out of stock)`;
            return `${v.size} (in stock: ${stock})`;
        }

        function updateRequestLink() {
            const v = selectedVariant();
            const size = v?.size || "";
            const qs = new URLSearchParams();
            qs.set("reason", "apparel-size-request");
            qs.set("slug", slug);
            if (size) qs.set("size", size);
            requestSizeLink.href = `/contact?${qs.toString()}`;
        }

        function renderStock() {
            const v = selectedVariant();
            if (!v) {
                stockLine.textContent = "";
                qtyInput.max = "";
                updateRequestLink();
                return;
            }

            const stock = Number(v.stock || 0);
            const active = Number(v.active || 0);

            if (active !== 1) {
                stockLine.textContent = "This size is currently unavailable.";
                qtyInput.max = "";
            } else if (stock <= 0) {
                stockLine.textContent = "Out of stock.";
                qtyInput.max = "";
            } else {
                stockLine.textContent = `In stock: ${stock} • $${centsToDollars(v.priceCents)}`;
                const q = Number(qtyInput.value || 1);
                if (q > stock) qtyInput.value = String(stock);
                qtyInput.max = String(stock);
            }

            updateRequestLink();
        }

        async function loadVariants() {
            setError("");
            sizeSelect.disabled = true;
            checkoutBtn.disabled = true;
            sizeSelect.innerHTML = `<option value="">Loading sizes…</option>`;
            stockLine.textContent = "";

            const r = await fetch(`/api/item?slug=${encodeURIComponent(slug)}`, { cache: "no-store" });
            const data = await r.json().catch(() => ({}));

            if (!r.ok) {
                sizeSelect.innerHTML = `<option value="">Unavailable</option>`;
                return;
            }

            variants = Array.isArray(data.variants) ? data.variants : [];

            if (variants.length === 0) {
                sizeSelect.innerHTML = `<option value="">Unavailable</option>`;
                return;
            }

            sizeSelect.innerHTML =
                `<option value="">Select size…</option>` +
                variants.map(v => {
                    const stock = Number(v.stock || 0);
                    const active = Number(v.active || 0);
                    const disabled = (active !== 1 || stock <= 0) ? "disabled" : "";
                    return `<option value="${v.size}" ${disabled}>${optionLabel(v)}</option>`;
                }).join("");

            sizeSelect.disabled = false;
            updateRequestLink();
        }

        sizeSelect.addEventListener("change", () => {
            setError("");
            checkoutBtn.disabled = !sizeSelect.value;
            renderStock();
        });

        qtyInput.addEventListener("input", () => {
            setError("");
            renderStock();
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            setError("");

            const v = selectedVariant();
            if (!v) {
                setError("Please select a size.");
                return;
            }

            const stock = Number(v.stock || 0);
            const active = Number(v.active || 0);
            if (active !== 1) {
                setError("This size is not available.");
                return;
            }
            if (stock <= 0) {
                setError("Out of stock.");
                return;
            }

            const quantity = Number(qtyInput.value || 1);
            if (!Number.isInteger(quantity) || quantity < 1) {
                setError("Quantity must be at least 1.");
                return;
            }
            if (quantity > stock) {
                setError("Out of stock.");
                qtyInput.value = String(stock);
                return;
            }

            checkoutBtn.disabled = true;

            try {
                const resp = await fetch(`/api/stripe/checkout`, {
                    method: "POST",
                    headers: { "content-type": "application/json" },
                    body: JSON.stringify({ slug, size: v.size, quantity }),
                });

                const body = await resp.json().catch(() => ({}));

                if (!resp.ok) {
                    const code = body?.error || "unknown";
                    if (code === "out_of_stock") {
                        setError("Out of stock.");
                        await loadVariants();
                        return;
                    }
                    if (code === "variant_inactive" || code === "missing_stripe_price_id") {
                        setError("This size is not available.");
                        await loadVariants();
                        return;
                    }
                    setError("Checkout failed. Please try again.");
                    return;
                }

                if (!body?.url) {
                    setError("Checkout failed. Please try again.");
                    return;
                }

                window.location.href = body.url;
            } catch {
                setError("Checkout failed (network). Please try again.");
            } finally {
                checkoutBtn.disabled = !sizeSelect.value;
            }
        });

        loadVariants().catch(() => {
            sizeSelect.innerHTML = `<option value="">Error loading sizes</option>`;
            sizeSelect.disabled = true;
            checkoutBtn.disabled = true;
        });
    </script>
    <style>

        .apparel-form {
            max-width: 520px;
            margin: 0 auto;
        }

        .apparel-form label {
            font-size: 1rem;
        }

        .apparel-form select,
        .apparel-form input[type="number"] {
            width: 100%;
            max-width: 420px;
            font-size: 16px;
            line-height: 1.25;
            padding: 10px 12px;
            min-height: 44px;
            box-sizing: border-box;
            border-radius: 8px;
        }

        .apparel-form select:disabled,
        .apparel-form input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .apparel-form .muted {
            font-size: 0.95rem;
        }

        .apparel-buttons {
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</MainLayout>
