---
import AdminLayout from "../layout/AdminLayout.astro";

export const prerender = false; // force runtime (server) rendering

const cookies = Astro.cookies;

// read from the same runtime env that /admin/env-test is using
const env = Astro.locals.runtime?.env ?? {};
const ADMIN_USER   = env.ADMIN_USER;
const ADMIN_PASS   = env.ADMIN_PASS;
const ADMIN_SECRET = env.ADMIN_SECRET;

let error: string | null = null;

// log once so we know what the server sees
if (!ADMIN_USER || !ADMIN_PASS || !ADMIN_SECRET) {
    console.warn("[admin] Missing ADMIN_USER / ADMIN_PASS / ADMIN_SECRET in runtime env");
}

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const username = formData.get("username");
    const password = formData.get("password");

    const valid =
        typeof username === "string" &&
        typeof password === "string" &&
        typeof ADMIN_USER === "string" &&
        typeof ADMIN_PASS === "string" &&
        username === ADMIN_USER &&
        password === ADMIN_PASS;

    if (!valid) {
        error = "Invalid username or password";
    } else {
        cookies.set("admin_auth", ADMIN_SECRET as string, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "strict",
            maxAge: 60 * 60 * 6, // 6 hours
        });

        // nicer Astro redirect helper
        return Astro.redirect("/admin/dashboard");
    }
}
---
<AdminLayout title="Admin Login">
    <h1 class="admin-title">Admin Login</h1>

    {error && <p class="admin-error">{error}</p>}

    <form method="POST" class="admin-form">
        <label class="admin-field-label">
            <span>Username</span>
            <input type="text" name="username" required class="admin-input" autocomplete="username"/>
        </label>

        <label class="admin-field-label">
            <span>Password</span>
            <input type="password" name="password" required class="admin-input" autocomplete="current-password"/>
        </label>

        <button type="submit" class="btn admin-btn">
            Login
        </button>
    </form>
</AdminLayout>