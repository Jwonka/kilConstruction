---
import AdminLayout from "../layout/AdminLayout.astro";
import {
    safeEquals,
    recordLoginAttempt,
    tooManyLoginAttempts,
} from "../utils/adminAuth";
import { createAdminToken } from "../utils/adminToken";

const cookies = Astro.cookies;
let error = Astro.url.searchParams.get("error") ?? "";

// Cloudflare runtime env
const env = (Astro.locals as any).runtime?.env ?? {};

const ADMIN_USER   = env.ADMIN_USER;
const ADMIN_PASS   = env.ADMIN_PASS;
const ADMIN_SECRET = env.ADMIN_SECRET;
const SESSION_VERSION = env.SESSION_VERSION ?? "1";

// Fail CLOSED if env is misconfigured
if (!ADMIN_USER || !ADMIN_PASS || !ADMIN_SECRET || !SESSION_VERSION) {
    console.error("[admin] Missing ADMIN_* or SESSION_VERSION in runtime env");
    return new Response("Something went wrong. Please try again later.", { status: 500 });
}

// Basic per-IP rate limiting using helpers
const ip =
    Astro.request.headers.get("CF-Connecting-IP") ||
    Astro.request.headers.get("x-forwarded-for") ||
    "unknown";

if (tooManyLoginAttempts(ip)) {
    console.warn("[login] too many attempts from", ip);
    return new Response("Too many attempts, try again later", { status: 429 });
}

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const username = formData.get("username");
    const password = formData.get("password");

    const userStr = typeof username === "string" ? username : "";
    const passStr = typeof password === "string" ? password : "";

    const userOk = safeEquals(userStr, ADMIN_USER);
    const passOk = safeEquals(passStr, ADMIN_PASS);
    const valid = userOk && passOk;

    recordLoginAttempt(ip, valid);

    if (!valid) {
        error = "Invalid username or password";
    } else {
        // Create a signed admin token using ADMIN_SECRET
        const token = await createAdminToken(ADMIN_SECRET, SESSION_VERSION);

        cookies.set("admin_auth", token, {
            path: "/",
            httpOnly: true,
            secure: import.meta.env.PROD,
            sameSite: "strict",
            maxAge: 60 * 60 * 2, // 2 hours; token itself also expires
        });

        return Astro.redirect("/admin/dashboard");
    }
}
---

<AdminLayout title="Admin Login" description="Sign in to the KIL Construction admin dashboard.">
    <h1 class="admin-title">Admin Login</h1>

    {error && <p class="admin-error">{error}</p>}

    <form method="POST" class="admin-form">
        <label class="admin-field-label">
            <span>Username</span>
            <input type="text" name="username" required class="admin-input" autocomplete="username"/>
        </label>

        <label class="admin-field-label">
            <span>Password</span>
            <input type="password" name="password" required class="admin-input" autocomplete="current-password"/>
        </label>

        <button type="submit" class="btn admin-btn">
            Login
        </button>
    </form>
</AdminLayout>