---
import "../../styles/global.css";

type Project = {
    slug: string; name: string; location?: string; year?: string;
    summary?: string; images: {full:string; thumb:string; name:string}[];
    };

const api = import.meta.env.PUBLIC_GALLERY_API as string;
const { slug } = Astro.params;

let project: Project | null = null;
let images: Project["images"] = [];
let items: Photo[] = [];
let loadError: string | null = null;


const res = await fetch(api, { cache: 'reload' }).catch((e: unknown) => {
    loadError = e instanceof Error ? e.message : 'Network error';
    return null; // so the rest of the code can branch safely
});

if (res) {
    if (res.ok) {
        // 2) Try to parse JSON; if that fails, still avoid throw
        const json = (await res
            .json()
            .catch(() => ({ items: [] }))) as { items?: Photo[] };

        items = json.items ?? [];
    } else {
        loadError = `HTTP ${res.status}`;
    }
}
---
<main class="container">
    {project ? (
            <>
                <h1>{project.name}</h1>
                {(project.location || project.year) && <p>{[project.location, project.year].filter(Boolean).join(' · ')}</p>}
                {project.summary && <p class="summary">{project.summary}</p>}

                {images.length ? (
                        <div class="grid">
                            {images.map(i => <img src={i.thumb} alt={project!.name} loading="lazy" />)}
                        </div>
                ) : (
                        <p>No images yet.</p>
                )}
            </>
    ) : (
            <p class="error">Project not found{loadError ? ` — ${loadError}` : ''}.</p>
    )}
</main>

<style>
    .container { max-width: 980px; margin: 0 auto; padding: 1rem; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .summary { color:#4b5563; margin-top:8px; }
    .error { color:#b91c1c; margin-top:12px; }
</style>
